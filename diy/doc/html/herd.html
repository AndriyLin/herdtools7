<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<meta name="generator" content="hevea 2.27">
<link rel="stylesheet" type="text/css" href="diy.css">
<title>Simulating memory models with herd7</title>
</head>
<body>
<a href="gen.html"><img src="previous_motif.gif" alt="Previous"></a>
<a href="index.html"><img src="contents_motif.gif" alt="Up"></a>
<a href="examples.html"><img src="next_motif.gif" alt="Next"></a>
<hr>
<table class="center"><tr><td><h1 class="part" id="part:herd">Part&#XA0;III<br>
Simulating memory models with <span class="c007">herd7</span></h1></td></tr>
</table>
<ul>
<li><a href="herd.html#sec69">Writing simple models</a>
<ul>
<li><a href="herd.html#sec70">Sequential consistency</a>
</li><li><a href="herd.html#sec71">Total Store Order (TSO)</a>
</li><li><a href="herd.html#sec72">Sequential consistency, total order definition</a>
</li><li><a href="herd.html#sec%3Acos">Computing coherence orders</a>
</li></ul>
</li><li><a href="herd.html#sec74">Producing pictures of executions</a>
<ul>
<li><a href="herd.html#sec75">Graph modes</a>
</li><li><a href="herd.html#show%3Aforbidden">Showing forbidden executions</a>
</li></ul>
</li><li><a href="herd.html#herd%3Alanguage">Model definitions</a>
<ul>
<li><a href="herd.html#overview">Overview</a>
</li><li><a href="herd.html#language%3Aidentifier">Identifiers</a>
</li><li><a href="herd.html#language%3Aexpression">Expressions</a>
</li><li><a href="herd.html#language%3Ainstruction">Instructions</a>
</li><li><a href="herd.html#sec99">Bell extensions</a>
</li><li><a href="herd.html#language%3Amodel">Models</a>
</li><li><a href="herd.html#sec%3Aprimitive">Primitives</a>
</li><li><a href="herd.html#sec%3Alibrary">Library</a>
</li></ul>
</li><li><a href="herd.html#sec108">Usage of <span class="c007">herd7</span></a>
<ul>
<li><a href="herd.html#sec109">Arguments</a>
</li><li><a href="herd.html#sec110">Options</a>
</li><li><a href="herd.html#herd%3Aconfigfile">Configuration files</a>
</li><li><a href="herd.html#herd%3Asearchpath">File searching</a>
</li></ul>
</li></ul>
<p>The tool <span class="c007">herd7</span> is a memory model simulator.
Users may write simple, single events,
axiomatic models of their own and run litmus tests on top
of their model.
The <span class="c007">herd7</span> distribution already includes some models.</p><p>The authors of&#XA0;<span class="c007">herd7</span> are Jade Alglave and Luc Maranget.</p>
<h2 class="section" id="sec69">12&#XA0;&#XA0;Writing simple models</h2>
<p>
This section introduces <span class="c004">cat</span>, our language for describing memory models.
The <span class="c004">cat</span> language is a domain specific language for writing and executing
memory models. From the language perspective, <span class="c004">cat</span> is loosely inspired
by OCaml. That is, it is a functional language, with similar syntax
and constructs.
The basic values of <span class="c004">cat</span> are sets of events, which include memory events
but also additional events such as fence events,
and relations over events.</p>
<h3 class="subsection" id="sec70">12.1&#XA0;&#XA0;Sequential consistency</h3>
<p>
The simulator <span class="c007">herd7</span> accepts models written in text files.
For instance here is <a href="sc.cat"><span class="c004">sc.cat</span></a>,
the definition of the sequentially consistent (SC) model in the partial-order
style:
</p><pre class="verbatim">SC

include "fences.cat"
include "cos.cat"

(* Atomic *)
empty rmw &amp; (fre;coe) as atom

(* Sequential consistency *)
acyclic po | fr | rf | co as sc
</pre><p>
The model above illustrates some features of model definitions:
</p><ol class="enumerate" type=1><li class="li-enumerate">
A model file starts with a tag (here <code>SC</code>), which can also be a
string (in double quotes) in case the tag includes special characters or spaces.
</li><li class="li-enumerate">Pre-defined bindings. Here <code>po</code> (program order)
and <span class="c004">rf</span> (read from) are pre-defined.
The remaining two communication relations (<span class="c004">co</span> and&#XA0;<span class="c004">fr</span>)
are computed by the included file <code>cos.cat</code>, which we describe later
&#X2014; See Sec.&#XA0;<a href="#sec%3Acos">12.4</a>.
For simplicity, we may as well assume that <code>co</code>
and&#XA0;<code>fr</code> are pre-defined.
</li><li class="li-enumerate">The computation of new relations from other relations,
and their binding to a name with the <code>let</code> construct.
Here, a new relation <code>com</code> is the union &#X201C;<span class="c004">|</span>&#X201D; of
the three pre-defined communication relations.
</li><li class="li-enumerate">The peformance of some checks. Here the relation &#X201C;<code>po | com</code>&#X201D;
(<em>i.e.</em> the union of program order <span class="c007">po</span> and of communication
relations) is required to be acyclic.
Checks can be given names by suffixing them with
&#X201C;<span class="c004">as&#XA0;</span><span class="c010">name</span>&#X201D;.
This last feature will be used in Sec.&#XA0;<a href="#name%3Acheck">13.2</a>
</li></ol><p>One can then run some litmus test, for instance <a href="SB.litmus"><span class="c008">SB</span></a>
(for <em>Store Buffering</em>,
see also Sec.&#XA0;<a href="litmus.html#litmus%3Asimple">1.1</a>), on top of the SC model:
</p><pre class="verbatim">% herd7 -model ./sc.cat SB.litmus
Test SB Allowed
States 3
0:EAX=0; 1:EAX=1;
0:EAX=1; 1:EAX=0;
0:EAX=1; 1:EAX=1;
No
Witnesses
Positive: 0 Negative: 3
Condition exists (0:EAX=0 /\ 1:EAX=0)
Observation SB Never 0 3
Hash=7dbd6b8e6dd4abc2ef3d48b0376fb2e3
</pre><p>The output of <span class="c007">herd7</span> mainly consists in
the list of final states that are allowed by the simulated model.
Additional output relates to the test condition.
One sees that the test condition does not validate on top of SC,
as &#X201C;<span class="c004">No</span>&#X201D; appears just after the list of final states
and as there is no &#X201C;Positive&#X201D; witness.
Namely, the condition &#X201C;<code>exists (0:EAX=0 /\ 1:EAX=0)</code>&#X201D;
reflects a non-SC behaviour, see Sec.&#XA0;<a href="#intro%3Acandidate">12.1</a>.</p><p><a id="intro:candidate"></a>The simulator <span class="c007">herd7</span> works by generating all candidate executions
of a given test.
By &#X201C;candidate execution&#X201D; we mean a choice of events,
program order&#XA0;<span class="c007">po</span>, of the read-from relation&#XA0;<span class="c004">rf</span>
and of final writes to memory
(last write to a given location)<sup><a id="text4" href="#note4">4</a></sup>.
In the case of the <span class="c008">SB</span> example, we get the following four executions:
</p><div class="center">
<img src="SB-00.png">&#XA0;&#XA0;&#XA0;&#XA0;<img src="SB-01.png">&#XA0;&#XA0;&#XA0;&#XA0;<img src="SB-02.png">&#XA0;&#XA0;&#XA0;&#XA0;<img src="SB-03.png">
</div><p>
Indeed, there is no choice for the program order <span class="c007">po</span>, as there are no
conditional jumps in this example; and no choice for the final
writes either, as there is only one store per location, which
must be <span class="c007">co</span>-after the initial stores (pictured as small red dots).
Then, there are two read events from locations <span class="c010">x</span> and&#XA0;<span class="c010">y</span> respectively,
which take their values either from the initial stores or from
the stores in program. As a result, there are four possible executions.
The model <a href="sc.cat"><span class="c004">sc.cat</span></a> gets executed on each of the four
candidate executions. The three first executions
are accepted and the last one is rejected, as it presents a cycle
in <span class="c004">po | fr</span>.
On the following diagram,
the cycle is obvious:
</p><div class="center"><img src="SB+SC.png"></div>
<h3 class="subsection" id="sec71">12.2&#XA0;&#XA0;Total Store Order (TSO)</h3>
<p>
However, the non-SC execution <a href="litmus.html#x86%3Aclassic">shows up</a> on x86 machines,
whose memory model is TSO. As TSO relaxes the write-to-read order, we attempt
to write a TSO model <a href="tso-00.cat"><span class="c004">tso-00.cat</span></a>, by simply removing write-to-read
pairs from the acyclicity check:
</p><pre class="verbatim">"A first attempt for TSO"

include "cos.cat"

(* Communication relations that order events*)
let com-tso = rf | co | fr
(* Program order that orders events *)
let po-tso = po &amp; (W*W | R*M)

(* TSO global-happens-before *)
let ghb = po-tso | com-tso
acyclic ghb as tso
show ghb
</pre><p>
This model illustrates several features
of model definitions:
</p><ul class="itemize"><li class="li-itemize">
New predefined sets: <code>W</code>, <code>R</code> and&#XA0;<code>M</code>, which are
the sets of read events, write events and of memory events, respectively.
</li><li class="li-itemize">The cartesian product operator &#X201C;<code>*</code>&#X201D; that returns the cartesian
product of two event sets as a relation.
</li><li class="li-itemize">The intersection operator &#X201C;<code>&amp;</code>&#X201D; that operates on sets and
relations.
</li></ul><p>
As a result, the effect of the declaration
<code>let po-tso = po &amp; (W*W | R*M)</code> is to define <code>po-tso</code>
as the program order on memory events minus write-to-read pairs.</p><p>We run <a href="SB.litmus"><span class="c008">SB</span></a> on top of the tentative TSO model:
</p><pre class="verbatim">% herd7 -model tso-00.cat SB.litmus 
Test SB Allowed
States 4
0:EAX=0; 1:EAX=0;
0:EAX=0; 1:EAX=1;
0:EAX=1; 1:EAX=0;
0:EAX=1; 1:EAX=1;
Ok
Witnesses
Positive: 1 Negative: 3
...
</pre><p><a id="sb:image"></a>The non-SC behaviour is now accepted, as write-to-read <span class="c007">po</span>-pairs
do not participate to the acyclicity check any more. In effect, this allows
the <a href="SB-03.png">last execution</a> above,
as <span class="c007">ghb</span> (<em>i.e.</em>
<code>po-tso | com-tso</code>) is acyclic.
</p><div class="center"><img src="SB+TSO.png"></div><p>However,
our model <a href="tso-00.cat"><span class="c004">tso-00.cat</span></a> is flawed: it is still to strict,
forbidding some behaviours that the TSO model should accept.
Consider the test <a href="SB+rfi-pos.litmus"><span class="c008">SB+rfi-pos</span></a>,
which is test <a href="STFW-PPC.litmus"><span class="c008">STFW-PPC</span></a> for X86 from Sec.&#XA0;<a href="litmus.html#stfw">1.3</a> with a normalised name (see Sec.&#XA0;<a href="gen.html#sec%3Anames">10.1</a>).
This test targets the following execution:
</p><div class="center"><img src="SB+rfi-pos.png"></div><p>
Namely the test condition
<code>exists (0:EAX=1 /\ 0:EBX=0 /\ 1:EAX=1 /\ 1:EBX=0)</code>
specifies that Thread&#XA0;0 writes&#XA0;1 into location&#XA0;<span class="c010">x</span>,
reads the value 1&#XA0;from the location&#XA0;<span class="c010">x</span> (possibly by store forwarding) and
then reads the value&#XA0;0 from the location&#XA0;<span class="c010">y</span>;
while Thread&#XA0;1 writes&#XA0;1 into&#XA0;<span class="c010">y</span>,
reads&#XA0;1 from&#XA0;<span class="c010">y</span> and then reads&#XA0;0 from&#XA0;<span class="c010">x</span>.
Hence, this test derives from the previour&#XA0;<a href="SB.litmus"><span class="c008">SB</span></a>
by adding loads in the middle, those loads
being satisfied from local stores.
As can be seen by running the test on top of the <a href="tso-00.cat"><span class="c004">tso-00.cat</span></a>
model, the target execution is forbidden:
</p><pre class="verbatim">% herd7 -model tso-00.cat SB+rfi-pos.litmus 
Test SB+rfi-pos Allowed
States 15
0:EAX=0; 0:EBX=0; 1:EAX=0; 1:EBX=0;
...
0:EAX=1; 0:EBX=1; 1:EAX=1; 1:EBX=1;
No
Witnesses
Positive: 0 Negative: 15
..
</pre><p>However, running the test with litmus demonstrates that the behaviour
is observed on some X86 machine:
</p><pre class="verbatim">% arch
x86_64
% litmus7 -mach x86 SB+rfi-pos.litmus
...
Test SB+rfi-pos Allowed
Histogram (4 states)
11589 *&gt;0:EAX=1; 0:EBX=0; 1:EAX=1; 1:EBX=0;
3993715:&gt;0:EAX=1; 0:EBX=1; 1:EAX=1; 1:EBX=0;
3994308:&gt;0:EAX=1; 0:EBX=0; 1:EAX=1; 1:EBX=1;
388   :&gt;0:EAX=1; 0:EBX=1; 1:EAX=1; 1:EBX=1;
Ok

Witnesses
Positive: 11589, Negative: 7988411
Condition exists (0:EAX=1 /\ 0:EBX=0 /\ 1:EAX=1 /\ 1:EBX=0) is validated
...
</pre><p>As a conclusion, our tentative TSO model is too strong.
The following diagram pictures its <span class="c007">ghb</span> relation:
</p><div class="center"><img src="SB+rfi-pos+TER.png"></div><p>
One easily sees that <span class="c007">ghb</span> is cyclic, wheras it should not.
Namely, the internal read-from relation&#XA0;<span class="c007">rfi</span> does
not create global order in the TSO model.
Hence, <span class="c007">rfi</span> is not included in <span class="c007">ghb</span>.
We rephrase our tentative TSO model, resulting into the new model
<a href="tso-01.cat"><span class="c004">tso-01.cat</span></a>:
</p><pre class="verbatim">"A second attempt for TSO"

include "cos.cat"

(* Communication relations that order events*)
let com-tso = rfe | co | fr
(* Program order that orders events *)
let po-tso = po &amp; (W*W | R*M)

(* TSP global-happens-before *)
let ghb = po-tso | com-tso
acyclic ghb
show ghb
</pre><p>
As can be observed above <span class="c004">rfi</span> (internal read-from) is no longer
included in <span class="c007">ghb</span>. However, <span class="c004">rfe</span> (external read-from)
still is. Notice that <span class="c004">rfe</span> and&#XA0;<span class="c004">rfi</span> are pre-defined.</p><p>As intended, this new tentative TSO model allows the behaviour of test&#XA0;<a href="SB+rfi-pos.litmus"><span class="c008">SB+rfi-pos</span></a>:
</p><pre class="verbatim">%  herd7 -model tso-01.cat SB+rfi-pos.litmus
Test SB+rfi-pos Allowed
States 16
...
0:EAX=1; 0:EBX=1; 1:EAX=1; 1:EBX=0;
...
Ok
Witnesses
Positive: 1 Negative: 15
...
</pre><p>And indeed, the global-happens-before relation is no-longer cyclic:
</p><div class="center"><img src="SB+rfi-pos+BIS.png"></div><p>We are not done yet, as our model is too weak in two aspects.
First, it has no semantics for fences.
As a result the test <a href="SB+mfences.litmus"><span class="c008">SB+mfences</span></a> is allowed, whereas it should
be forbidden, as this is the very purpose of the fence <span class="c004">mfence</span>.
</p><div class="center"><img src="SB+mfences.png"></div><p>
One easily solves this issue by first defining the <code>mfence</code>
that relates events with a <code>MFENCE</code> event <span class="c004">po</span>-in-between them;
and then by adding <code>mfence</code> to the definition of <code>po-tso</code>:
</p><pre class="verbatim">let mfence = po &amp; (_ * MFENCE) ; po
let po-tso = po &amp; (W*W | R*M) | mfence
</pre><p>Notice how the relation <code>mfence</code> is defined from two pre-defined sets:
&#X201C;<code>_</code>&#X201D; the universal set of all events and <code>MFENCE</code> the set
of fence events generated by the X86 <span class="c004">mfence</span> instruction.
An alternative, more precise definition, is possible:
</p><pre class="verbatim">let mem-to-mfence = po &amp; M * MFENCE
let mfence-to-mem = po &amp; MFENCE * M
let mfence = mem-to-mfence; mfence-to-mem
</pre><p>This alternative definition of <span class="c004">mfence</span>,
although yielding a smaller relation, is equivalent to the original one
for our purpose of checking <span class="c004">ghb</span> acyclicity.</p><p>But the resulting model is still too weak,
as it allows some behaviours that any model must
reject for the sake of single thread correctness.
The following test <a href="CoRWR.litmus"><span class="c008">CoRWR</span></a> illustrates the issue:
</p><pre class="verbatim">X86 CoRWR
{ }
 P0          ;
 MOV EAX,[x] ;
 MOV [x],$1  ;
 MOV EBX,[x] ;
exists (0:EAX=1 /\ 0:EBX=0)
</pre><p>
The test final condition targets the following excution candidate:
</p><div class="center"><img src="CoRWR.png"></div><p>
The TSO check &#X201C;<code>acyclic po-tso|com-tso</code>&#X201D; does not suffice to reject
two absurd behaviours pictured in the execution diagram above:
(1) the read&#XA0;<span class="c010">a</span> is allowed to
read from the <span class="c007">po</span>-after write&#XA0;<span class="c010">b</span>, as <span class="c007">rfi</span> is not included
in <span class="c007">com-tso</span>; and&#XA0;(2)
the read&#XA0;<span class="c010">c</span> is allowed to read the initial value of location&#XA0;<span class="c010">x</span>
although the initial write&#XA0;<span class="c010">d</span> is <span class="c007">co</span>-before the write&#XA0;<span class="c010">b</span>,
since <code>po &amp; (W * R)</code> is not in <span class="c007">po-tso</span>.</p><p><a id="defuniproc"></a>For any model, we rule out those very
untimely behaviours by the so-called
<span class="c012">uniproc</span>
check that states that executions projected on events that access one variable
only are SC.
In practice, having defined <code>po-loc</code> as <code>po</code> restricted to
events that touch the same address (<em>i.e.</em>
as <code>po &amp; loc</code>), we further require the acyclicity
of the relation <code>po-loc|fr|rf|co</code>.
In the TSO case, the <span class="c012">uniproc</span>&#XA0;check can be
somehow simplified by considering only
the cycles in <code>po-loc|fr|rf|co</code> that 
are not already rejected by the main check of the model.
This amounts to design specific checks for the two relations that are
not global in TSO: <code>rfi</code> and <code>po &amp; (W*R)</code>.
Doing so, we finally produce a correct model for TSO <a href="tso-02.cat"><span class="c004">tso-02.cat</span></a>:
</p><pre class="verbatim">"A third attempt for TSO"

include "cos.cat"

(* Uniproc check specialized for TSO *)
irreflexive po-loc &amp; (R*W); rfi as uniprocRW
irreflexive po-loc &amp; (W*R); fri as uniprocWR

(* Communication relations that order events*)
let com-tso = rfe | co | fr

(* Program order that orders events *)
let mfence = po &amp; (_ * MFENCE) ; po
let po-tso = po &amp; (W*W | R*M) | mfence

(* TSP global-happens-before *)
let ghb = po-tso | com-tso
show mfence,ghb
acyclic ghb as tso


</pre><p>
This last model illustrates another feature of <span class="c004">cat</span>:
<span class="c007">herd7</span> may also performs irreflexivity checks with the keyword
&#X201C;<code>irreflexive</code>&#X201D;.</p>
<h3 class="subsection" id="sec72">12.3&#XA0;&#XA0;Sequential consistency, total order definition</h3>
<p>
We now illustrate another style of model.
We consider the original definition of sequential consistency&#XA0;[<a href="diy006.html#lam79">3</a>].
An execution is SC when there exists a total order&#XA0;<code>S</code> on events such that:
</p><ol class="enumerate" type=1><li class="li-enumerate">
<span class="c010">S</span> includes the program order&#XA0;<code>po</code>;
</li><li class="li-enumerate"><a id="rfcond"></a>and read events read from the most recent write events in the past,
<em>i.e.</em> a read&#XA0;<span class="c010">r</span> from location&#XA0;<span class="c010">x</span> reads the value stored by
the <code>S</code>-maximal write amongst those writes to location&#XA0;<span class="c010">x</span>
that are <code>S</code> smaller than&#XA0;<span class="c010">r</span>.
</li></ol><p>
So we could just generate all total orders amongst memory events,
and filter those &#X201C;scheduling order candidates&#X201D; according to the two rules
above.</p><p><a id="sec:final:initial"></a>Things are a bit more complex in&#XA0;<span class="c007">herd7</span>, due to the presence of initial and final writes.
Up to now we have ignored initial and final writes, we are now going to
integrate them explicitly.</p><p>Initial writes are write events that initialise the memory locations.
Initial writes are not generated by the instructions of the test.
Instead, they are created by <span class="c007">herd7</span> machinery, and are available
from model text as the set <code>IW</code>.</p><p>Final writes may be generated by program instructions, and, when such,
they must be ordered by&#XA0;<span class="c010">S</span>.
A final write is a write to a phantom read performed once
program execution is over.
The constraint on final writes
originates from <span class="c007">herd7</span> technique to enumerate execution candidates:
actual execution candidates also include a choice of final writes for
the locations that are observed in the test final condition<sup><a id="text5" href="#note5">5</a></sup>.
As test outcome (<em>i.e.</em> the final values of observed locations) is
settled before executing the model, it is important <em>not</em> to accept
executions that yield a different outcome. Doing so may validate outcomes
that should be rejected.
In practice, the final write <span class="c010">w</span><sub><span class="c010">f</span></sub>
to location&#XA0;<span class="c010">x</span> must follow all other writes to&#XA0;<span class="c010">x</span> in&#XA0;<span class="c010">S</span>.
Considering that the set of final writes is available to <span class="c004">cat</span>&#XA0;models
as the pre-defined set&#XA0;<code>FW</code>,
the constraint on final writes
can be expressed as a relation:
</p><pre class="verbatim">let preSC = loc &amp; (W \ FW) * FW
</pre><p>Where <code>loc</code> is a predefined relation that relates all events
that access the same location.</p><p>By contrast with final writes, initial writes are not generated
by program instructions, and it is possible not to order them completely.
In particular, it is not useful to order initial writes to different locations,
nor the initial write to location&#XA0;<span class="c010">x</span> with any access to location&#XA0;<span class="c010">y</span>.
Notice that we could include initial writes in&#XA0;<span class="c010">S</span> as we did for
final writes. Not doing so will improve efficiency.</p><p><a id="intro:linearisations"></a>Finally, the order&#XA0;<span class="c010">S</span> is not just any order on memory events (predefined
set&#XA0;<code>M</code>, which includes initial and final writes writes),
it is a topological order of the program events (implemented as the set
<code>M\IW</code>) that extends the pre-order&#XA0;<code>preSC</code>.
We can generate all such topological orders with the <span class="c004">cat</span>&#XA0;primitive
<code>linearisations</code>:
</p><pre class="verbatim">let allS = linearisations(M\IW,preSC)
</pre><p>The call <span class="c004">linearisation(</span><span class="c010">E</span><span class="c004">,</span><span class="c010">r</span><span class="c004">)</span>, where <span class="c010">E</span> is a set of events
and&#XA0;<span class="c010">r</span> is a relation on events, returns the set of all total
orders defined on&#XA0;<span class="c010">S</span> that extend&#XA0;<span class="c010">r</span>. Notice that if&#XA0;<span class="c010">r</span> is cyclic,
the empty set is returned.</p><p><a id="intro:with"></a>We now need to iterate over the set&#XA0;<code>allS</code>.
We do so with the <code>with</code> construct:
</p><pre class="verbatim">with S from allS
</pre><p>It is important to notice that the construct above extends the current
execution candidate (<em>i.e.</em> a choice of events, plus a choice of
two relations&#XA0;<span class="c004">po</span> and&#XA0;<span class="c004">rf</span>) with a candidate order&#XA0;<span class="c010">S</span>.
In other words, the scope of the iteration is the remainder of the model text.
Once model execution terminates for a choice of&#XA0;<span class="c010">S</span>
(some element of&#XA0;<span class="c004">allS</span>), model execution restarts just
after the <span class="c004">with</span> construct, with variable&#XA0;<span class="c010">S</span> bound to
the next choice picked in&#XA0;<span class="c004">allS</span>.</p><p>As a first consistency check, we check that <span class="c010">S</span> includes the program order:
</p><pre class="verbatim">empty po \ S as PoCons
</pre><p>Notice that, to check for inclusion, we test the emptyness of relation
difference (operator &#X201C;<code>\</code>&#X201D;).</p><p>It remains to check that the <span class="c004">rf</span> relation of the execution candidate
is the same as the one defined by condition&#XA0;<a href="#rfcond">2</a>.
To that aim, we complement&#XA0;<span class="c010">S</span> with the constraint over initial
writes that must precede all events to their location:
</p><pre class="verbatim">let S = S | loc &amp; IW * (M \ IW)
</pre><p>Observe that <span class="c010">S</span> is no longer a total order. However, it is still a total
order when restricted to events that access a given location,
which is all that matters for condition&#XA0;<a href="#rfcond">2</a> to give a value
to all reads. As regards our SC model, we define <span class="c004">rf-S</span>
the read-from relation induced by&#XA0;<span class="c010">S</span> as follows:
</p><pre class="verbatim">let WRS = W * R &amp; S &amp; loc  (* Writes from the past, same location *)
let rf-S = WRS \ (S;WRS)   (* Most recent amongst them *)
</pre><p>The definition is a two-step process: we first define
a relation&#XA0;<span class="c004">WRS</span> from writes to reads (to the same location)
that follow them in&#XA0;<span class="c010">S</span>. Observe that,
by complementing&#XA0;<span class="c010">S</span> with initial writes, we achieve that for any read&#XA0;<span class="c010">r</span>
there exists at least a write&#XA0;<span class="c010">w</span> such thar (<span class="c010">w</span>,<span class="c010">r</span>) &#X2208; <span class="c004">WRS</span>.
It then remains to filter out non-maximal writes in <span class="c004">WRS</span>
as we do in the definition of <span class="c004">rf-S</span>, by the means of
the difference operator &#X201C;<code>\</code>&#X201D;.
We then check the equality of <span class="c004">rf</span> (pre-defined as part of the candidate
execution) and of <span class="c004">rf-S</span> by double inclusion:
</p><pre class="verbatim">empty rf \ rf-S as RfCons
empty rf-S \ rf as RfCons
</pre><p>As an exemple, he show six attempts of <span class="c004">po</span> compatible <span class="c010">S</span>&#XA0;orders
for the non-SC outcome of the test&#XA0;<a href="SB.litmus"><span class="c008">SB</span></a> in figure&#XA0;<a href="#sblamport">3</a>.
</p><blockquote class="figure"><div class="center"><hr class="c026"></div>
<div class="caption"><table class="c001 cellpading0"><tr><td class="c023">Figure 3: <a id="sblamport"></a>Failed attempts of SC scheduling orders&#XA0;<span class="c010">S</span>.</td></tr>
</table></div>
<div class="center">
<img src="SB+L-00.png">&#XA0;&#XA0;<img src="SB+L-01.png">&#XA0;&#XA0;<img src="SB+L-02.png"><br>
<img src="SB+L-03.png">&#XA0;&#XA0;<img src="SB+L-04.png">&#XA0;&#XA0;<img src="SB+L-05.png">
</div>
<div class="center"><hr class="c026"></div></blockquote><p>
Observe that all attempts fail as <span class="c004">rf</span> and <span class="c004">rf-S</span>
are different in all diagrams.</p><p>We also show all successfull SC scheduling in figure&#XA0;<a href="#sbok">4</a>.
</p><blockquote class="figure"><div class="center"><hr class="c026"></div>
<div class="caption"><table class="c001 cellpading0"><tr><td class="c023">Figure 4: <a id="sbok"></a>SC executions of test&#XA0;<a href="SB.litmus"><span class="c008">SB</span></a>.</td></tr>
</table></div>
<div class="center">
<img src="SB+OK-00.png">&#XA0;&#XA0;<img src="SB+OK-01.png">&#XA0;&#XA0;<img src="SB+OK-02.png"><br>
<img src="SB+OK-03.png">&#XA0;&#XA0;<img src="SB+OK-04.png">&#XA0;&#XA0;<img src="SB+OK-05.png">
</div>
<div class="center"><hr class="c026"></div></blockquote><p>For reference we provide our complete model&#XA0;<a href="lamport.cat"><span class="c004">lamport.cat</span></a>
</p><pre class="verbatim">"SC, L. Lamport style"

(* writes to location x precede final write to location x *)
let preSC =  loc &amp; (W \ FW) * FW

(* Compute the set of total orders that extend preSC on program events *)
let allS = linearisations(M \ IW,preSC)

(* For all such orders *)
with S from allS

let PO = po
let POminusS = PO\S

(* Check compatibility with po *)
empty po \ S as ScPo

(* Add initial writes *)
let S = S | loc &amp; (IW * (M \ IW))


(* Define most recent write in the past  *)
let WRS = W * R &amp; S &amp; loc  (* Writes from the past, same location *)
let rf-S = WRS \ (S;WRS)   (* Most recent amongst them *)

(* Check equality with rf *)
empty rf \ rf-S as RfCons
empty rf-S \ rf as RfCons

</pre>
<h3 class="subsection" id="sec:cos">12.4&#XA0;&#XA0;Computing coherence orders</h3>
<p>
All the models seen so far include the file <a href="cos.cat"><span class="c004">cos.cat</span></a> that define
&#X201C;coherence relations&#X201D;, written&#XA0;<span class="c004">co</span>.
This section describes the file&#XA0;<span class="c004">cos.cat</span>.
It can be skipped in first reading, as users may find sufficient
to include the file.</p><p>For a given location&#XA0;<span class="c010">x</span> the coherence order is a total order on the
write events to location&#XA0;<span class="c010">x</span>. The coherence relation&#XA0;<span class="c004">co</span> is the union
of those total orders for all locations.
In this section, we show how to compute all possible coherence orders for
a candidate execution.
We seize the opportunity to introduce advanced features of the <span class="c004">cat</span>
language, such as functions and pattern matching over sets.</p><p>Possible coherence orders for a given location&#XA0;<span class="c010">x</span>
are not totally arbitrary in two aspects:
</p><ol class="enumerate" type=1><li class="li-enumerate">
The write events to location&#XA0;<span class="c010">x</span> include
the initial write event to location&#XA0;<span class="c010">x</span>. The initial write to&#XA0;<span class="c010">x</span> must come
first in any coherence order for&#XA0;<span class="c010">x</span>.
</li><li class="li-enumerate">One of the writes to&#XA0;<span class="c010">x</span> performed by the test (may) have been declared
to be final by <span class="c007">herd7</span> machinery prior to model execution.
In that case, the final write to&#XA0;<span class="c010">x</span> must come last in any coherence order
for&#XA0;<span class="c010">x</span>.
</li></ol><p>
See Sec.&#XA0;<a href="#sec%3Afinal%3Ainitial">12.3</a> for details on initial and final writes.</p><p>We can express the two conditions above for all locations of the program
as a relation <span class="c004">co0</span>:
</p><pre class="verbatim">let co0 = loc &amp; (IW*(W\IW)|(W\FW)*FW)
</pre><p>Where the pre-defined sets <span class="c004">IW</span> and&#XA0;<span class="c004">FW</span> are the sets
of all initial and final writes respectively.
</p><p>Then, assuming that <span class="c010">W</span><sub><span class="c010">x</span></sub> is the set of all writes to location&#XA0;<span class="c010">x</span>, one
can compute the set of all possible coherence orders for&#XA0;<span class="c010">x</span> with
the <span class="c004">linearisations</span> primitive as <span class="c004">linearisations(</span><span class="c010">W</span><sub><span class="c010">x</span></sub><span class="c004">,co0)</span>.
In practice, we define a function that takes the set&#XA0;<span class="c010">W</span><sub><span class="c010">x</span></sub> as an argument:
</p><pre class="verbatim">let makeCoX(Wx) = linearisations(Wx,co0)
</pre><p>The <span class="c004">linearisations</span> primitive is introduced in
Sec.&#XA0;<a href="#intro%3Alinearisations">12.3</a>. It returns all topological sorts
of the events of the set&#XA0;<span class="c004">Wx</span> that are compatible
with the relation&#XA0;<span class="c004">co0</span>.</p><p>In fact, we want to compute the set of all possible <span class="c004">co</span> relations,
<em>i.e.</em> all the unions of all the possible coherence orders for all
locations&#XA0;<span class="c010">x</span>. To that end we use another <span class="c004">cat</span> primitive:
<span class="c004">partition(</span><span class="c010">S</span><span class="c004">)</span>, which takes a set of events as argument and
returns a set of set of events <span class="c010">T</span> = {<span class="c010">S</span><sub>1</sub>,&#X2026;,<span class="c010">S</span><sub><span class="c010">n</span></sub>}, where each
<span class="c010">S</span><sub><span class="c010">i</span></sub> is the set of all events in <span class="c010">S</span> that act on location <span class="c010">L</span><sub><span class="c010">i</span></sub>,
and, of course <span class="c010">S</span> is the union &#X222A;<sub><span class="c010">i</span>=1</sub><sup><span class="c010">i</span>=<span class="c010">n</span></sup> <span class="c010">S</span><sub><span class="c010">i</span></sub>.
Hence we shall compute the set of all <span class="c004">Wx</span> sets
as <span class="c004">partition(W)</span>,
where <span class="c004">W</span> is the pre-defined set of all writes (including initial
writes).</p><p>For combining the effect of the <span class="c004">partition</span> and <span class="c004">linearisations</span>
primitives, we first define a <span class="c004">map</span> function that, given a set&#XA0;<span class="c010">S</span>=
{<span class="c010">e</span><sub>1</sub>,&#X2026;,<span class="c010">e</span><sub><span class="c010">n</span></sub>} and a function <span class="c010">f</span>, returns the set
{<span class="c010">f</span>(<span class="c010">e</span><sub>1</sub>),&#X2026;,<span class="c010">f</span>(<span class="c010">e</span><sub><span class="c010">n</span></sub>)}:
</p><pre class="verbatim">let map f  =
  let rec do_map S = match S with
  || {} -&gt; {}
  || e ++ S -&gt; f e ++ do_map S
  end in
  do_map
</pre><p>The <span class="c004">map</span> function is written in curried style.
That is one calls it as <span class="c004">map&#XA0;</span><span class="c010">f</span><span class="c004">&#XA0;</span><span class="c010">S</span>, parsed
as <span class="c004">(map&#XA0;</span><span class="c010">f</span><span class="c004">)&#XA0;</span><span class="c010">S</span>. More precisely, the left-most function
call&#XA0;<span class="c004">(map&#XA0;</span><span class="c010">f</span><span class="c004">)</span> returns a function.
Here it returns&#XA0;<span class="c004">do_map</span> with free variable <span class="c004">f</span> being bound
to the argument&#XA0;<span class="c010">f</span>.
The definition of&#XA0;<span class="c004">map</span> illustrate several new features:
</p><ol class="enumerate" type=1><li class="li-enumerate">
The empty set constant&#XA0;&#X201C;<code>{}</code>&#X201D;,
and the set addition operator <span class="c010">e</span><span class="c004"> ++ </span><span class="c010">S</span> that returns the set&#XA0;<span class="c010">S</span>
augmented with element&#XA0;<span class="c010">e</span>.
</li><li class="li-enumerate">Recursive function definitions. The function&#XA0;<code>do_map</code>
is recursive as it calls itself.
</li><li class="li-enumerate">Pattern matching on sets.
This construct, similar to OCaml pattern matching on lists, discriminates
between empty (<code>|| {} -&gt;</code>&#XA0;<span class="c010">e</span><sub>0</sub>) and non-empty
(<code>|| e ++ es -&gt;</code>&#XA0;<span class="c010">e</span><sub>1</sub>) sets.
In the second case of a non-empty set, the expression&#XA0;<span class="c010">e</span><sub>1</sub> is evaluated
in a context extended with two bindings: a binding from the variable&#XA0;<span class="c004">e</span>
to an arbitrary element of the matched set, and a binding from
the variable&#XA0;<span class="c004">es</span> to the matched set minus the arbitrary element.
</li></ol><p>Then, we generate the set of all possible coherence orders
for all locations&#XA0;<span class="c010">x</span> as follows:
</p><pre class="verbatim">let allCoX = map makeCoX (partition(W))
</pre><p>Notice that <span class="c004">allCoX</span> is a set of sets of relations,
each element being the set of all possible coherence orders
for a specific&#XA0;<span class="c010">x</span>. </p><p>We still need to generate all possible <span class="c004">co</span> relations,
that is all unions of the possible coherence orders for
all locations&#XA0;<span class="c010">x</span>. It can be done by another <span class="c004">cat</span> function:
<span class="c004">cross</span>, which takes a set of sets <span class="c010">S</span> = {<span class="c010">S</span><sub>1</sub>, <span class="c010">S</span><sub>2</sub>, &#X2026;, <span class="c010">S</span><sub><span class="c010">n</span></sub>} as
argument and returns all possible unions built by picking elements from each of
the <span class="c010">S</span><sub><span class="c010">i</span></sub>: 
</p><table class="display dcenter"><tr class="c020"><td class="dcell">&#X23A7;<br>
&#X23A8;<br>
&#X23A9;</td><td class="dcell">&#XA0;&#XA0;<span class="c010">e</span><sub>1</sub>&#XA0;&#X22C3;&#XA0;<span class="c010">e</span><sub>2</sub>&#XA0;&#X22C3;&#XA0;&#X22EF;&#XA0;&#X22C3;&#XA0;<span class="c010">e</span><sub><span class="c010">n</span></sub>&#XA0;&#X2223;
<span class="c010">e</span><sub>1</sub>&#XA0;&#X2208;&#XA0;<span class="c010">S</span><sub>1</sub>,&#XA0;<span class="c010">e</span><sub>2</sub>&#XA0;&#X2208;&#XA0;<span class="c010">S</span><sub>2</sub>,&#XA0;&#X2026;,&#XA0;<span class="c010">e</span><sub><span class="c010">n</span></sub>&#XA0;&#X2208;&#XA0;<span class="c010">S</span><sub><span class="c010">n</span></sub>&#XA0;&#XA0;</td><td class="dcell">&#X23AB;<br>
&#X23AC;<br>
&#X23AD;</td></tr>
</table><p>
One may notice that if <span class="c010">S</span> is empty, then <span class="c004">cross</span> should
return one relation exactly: the empty relation, <em>i.e.</em> the neutral
element of the union operator.
This choice for <span class="c004">cross(</span>&#X2205;<span class="c004">)</span> is natural
when we define <span class="c004">cross</span> inductively:
</p><table class="display dcenter"><tr class="c020"><td class="dcell"><span class="c004">cross</span>(<span class="c010">S</span><sub>1</sub>&#XA0;<span class="c004">++</span><span class="c010">S</span>)&#XA0;=
</td><td class="dcell"><table class="display"><tr><td class="dcell c013">&nbsp;</td></tr>
<tr><td class="dcell c013"><span style="font-size:xx-large">&#X222A;</span></td></tr>
<tr><td class="dcell c013"><span class="c010">e</span><sub>1</sub>&#XA0;&#X2208;&#XA0;<span class="c010">S</span><sub>1</sub>,&#XA0;<span class="c010">t</span>&#XA0;&#X2208;&#XA0;<span class="c004">cross</span>(<span class="c010">S</span>)</td></tr>
</table></td><td class="dcell">&#XA0;</td><td class="dcell">&#X23A7;<br>
&#X23A8;<br>
&#X23A9;</td><td class="dcell"><span class="c010">e</span><sub>1</sub>&#XA0;&#X22C3;&#XA0;<span class="c010">t</span>&#XA0;</td><td class="dcell">&#X23AB;<br>
&#X23AC;<br>
&#X23AD;</td></tr>
</table><p>
In the definition above, we simply build
<span class="c004">cross(</span><span class="c010">S</span><sub>1</sub> <span class="c004">++</span><span class="c010">S</span><span class="c004">)</span> by building the set
of all unions of one relation&#XA0;<span class="c010">e</span><sub>1</sub> picked in&#XA0;<span class="c010">S</span><sub>1</sub>
and of one relation&#XA0;<span class="c010">t</span> picked in <span class="c004">cross</span>(<span class="c010">S</span>).</p><p>So as to write&#XA0;<span class="c004">cross</span>,
we first define a classical <span class="c004">fold</span> function over sets:
given a set <span class="c010">S</span> = { <span class="c010">e</span><sub>1</sub>, <span class="c010">e</span><sub>2</sub>, &#X2026;, <span class="c010">e</span><sub><span class="c010">n</span></sub>}, an initial value&#XA0;<span class="c010">y</span><sub>0</sub>
and a function <span class="c010">f</span>&#XA0;that takes a pair (<span class="c010">e</span>,<span class="c010">y</span>) as argument,
<span class="c004">fold</span> computes:
</p><table class="display dcenter"><tr class="c020"><td class="dcell"><span class="c010">f</span>&#XA0;(<span class="c010">e</span><sub><span class="c010">i</span><sub>1</sub></sub>,<span class="c010">f</span>&#XA0;(<span class="c010">e</span><sub><span class="c010">i</span><sub>2</sub></sub>,&#XA0;&#X2026;,&#XA0;<span class="c010">f</span>(<span class="c010">e</span><sub><span class="c010">i</span><sub><span class="c010">n</span></sub></sub>,<span class="c010">y</span><sub>0</sub>)))&#XA0;&#XA0;
</td></tr>
</table><p>
where <span class="c010">i</span><sub>1</sub>, <span class="c010">i</span><sub>2</sub>, &#X2026;, <span class="c010">i</span><sub><span class="c010">n</span></sub> defines a permutation
of the indices 1, 2, &#X2026;, <span class="c010">n</span>.
</p><pre class="verbatim">let fold f =
  let rec fold_rec (es,y) = match es with
  || {} -&gt; y
  || e ++ es -&gt; fold_rec (es,f (e,y))
  end in
  fold_rec
</pre><p>The function&#XA0;<span class="c004">fold</span> is written in the same curried style as&#XA0;<span class="c004">map</span>.
Notice that the inner function&#XA0;<code>fold_rec</code> takes one argument.
However this argument is a pair.
As a gentle example of <span class="c004">fold</span> usage, we could have
defined&#XA0;<span class="c004">map</span> as:
</p><pre class="verbatim">let map f = fun S -&gt; fold (fun (e,y) -&gt; f e ++ y) (S,{})
</pre><p>This example also introduce &#X201C;anonymous&#X201D; functions.</p><p>As a more involved example of <span class="c004">fold</span> usage, we
write the function&#XA0;<span class="c004">cross</span>.
</p><pre class="verbatim">let rec cross S = match S with
  || {} -&gt; { 0 } (* 0 is the empty relation *)
  || S1 ++ S -&gt;
      let ts = cross S in
      fold
        (fun (e1,r) -&gt; map (fun t -&gt; e1 | t) ts | r)
        (S1,{})
  end      
</pre><p>The function&#XA0;<span class="c004">cross</span> is a recursive function over a set (of sets).
Its code follows the inductive definition given above.</p><p>Finally, we generate all possible <span class="c004">co</span> relations by:
</p><pre class="verbatim">let allCo = cross allCoX
</pre><p>The file&#XA0;<a href="cos.cat"><span class="c004">cos.cat</span></a> goes on by iterating over <span class="c004">allCo</span> using
the <span class="c004">with </span><span class="c010">x</span><span class="c004"> from&#XA0;</span><span class="c010">S</span> construct:
</p><pre class="verbatim">with co from allCo
</pre><p>See Sec.&#XA0;<a href="#intro%3Awith">12.3</a> for details on this construct.</p><p>Once&#XA0;<span class="c004">co</span> has been defined, one defines&#XA0;<span class="c004">fr</span> and
internal and external variations:
</p><pre class="verbatim">(* From now, co is a coherence relation *)
let coi = co &amp; int
let coe = co &amp; ext

(* Compute fr *)
let fr = rf^-1 ; co
let fri = fr &amp; int
let fre = fr &amp; ext
</pre><p>The pre-defined relation <span class="c004">ext</span> (resp. <span class="c004">int</span>) relates
events generated by different (resp. the same) threads.</p>
<h2 class="section" id="sec74">13&#XA0;&#XA0;Producing pictures of executions</h2>
<p>
The simulator <span class="c007">herd7</span> can be instructed to produce pictures of
executions.
Those pictures are instrumental in understanding and
debugging models.
It is important to understand that <span class="c007">herd7</span> does not produce pictures
by default. To get pictures one must instruct <span class="c007">herd7</span> to produce
pictures of some executions with the <span class="c004">-show</span> option.
This option accepts specific keywords, its default being &#X201C;<span class="c004">none</span>&#X201D;,
instructing <span class="c007">herd7</span> not to produce any picture.</p><p>A frequentlty used keyword is &#X201C;<span class="c004">prop</span>&#X201D; that means &#X201C;show the executions
that validate the proposition in the final condition&#X201D;.
Namely, the final condition in litmus test is a quantified
boolean proposition as for instance &#X201C;<code>exists (0:EAX=0 /\ 1:EAX=0)</code>&#X201D; at the end of test <a href="SB.litmus"><span class="c008">SB</span></a>.</p><p>But this is not enough, users also have to specify what to do with the picture:
save it in file in the DOT format of the
<a href="http://graphviz.org/"><span class="c007">graphviz</span> graph visualization software</a>, or
display the image,<sup><a id="text6" href="#note6">6</a></sup> or both.
One instructs <span class="c007">herd7</span> to save images with the <span class="c004">-o </span><span class="c010">dirname</span> option,
where <span class="c010">dirname</span> is the name of a directory, which must exists.
Then, when processing the file <span class="c010">name</span><span class="c004">.litmus</span>,
<span class="c007">herd7</span> will create a file <span class="c010">name</span><span class="c004">.dot</span> into the
directory&#XA0;<span class="c010">dirname</span>.
For displaying images, one uses the <span class="c004">-gv</span> option.</p><p><a id="sec:show"></a>As an example,
so as to display the image of the non-SC behaviour of <a href="SB.litmus"><span class="c008">SB</span></a>, one
should invoke <span class="c007">herd7</span> as:
</p><pre class="verbatim">% herd7 -model tso-02.cat -show prop -gv SB.litmus
</pre><p><a id="sb:cluster">As</a>
a result, users should see a window popping and displaying this image:
</p><div class="center"><img src="SB+CLUSTER.png"></div><p>
Notice that we got the PNG version of this image as follows:
</p><pre class="verbatim">% herd7 -model tso-02.cat -show prop -o /tmp SB.litmus
% dot -Tpng /tmp/SB.dot -o SB+CLUSTER.png
</pre><p>That is, we applied the <span class="c007">dot</span> tool from the
<a href="http://graphviz.org/"><span class="c007">graphviz</span></a> package, using the appropriate option
to produce a PNG image.</p><p>One may observe that there are <code>ghb</code> arrows in the diagram.
This results from the <code>show ghb</code> instruction
at the end of the model file&#XA0;<a href="tso-02.cat"><span class="c004">tso-02.cat</span></a>.</p>
<h3 class="subsection" id="sec75">13.1&#XA0;&#XA0;Graph modes</h3>
<p>
The image <a href="#sb%3Acluster">above</a> much differs from
the one in Sec.&#XA0;<a href="#sb%3Aimage">12.2</a> that describes the same execution
and that is reproduced in Fig.&#XA0;<a href="#fig%3Asb">5</a>
</p><blockquote class="figure"><div class="center"><hr class="c026"></div>
<div class="caption"><table class="c001 cellpading0"><tr><td class="c023">Figure 5: <a id="fig:sb"></a>The non-SC behaviour of <a href="SB.litmus"><span class="c008">SB</span></a> is allowed by TSO</td></tr>
</table></div>
<div class="center">
<img src="SB+TSO.png">
</div>
<div class="center"><hr class="c026"></div></blockquote><p><a id="mode:example"></a>In effect, <span class="c007">herd7</span> can produce three styles
of pictures, <span class="c007">dot</span> clustered pictures, <span class="c007">dot</span> free pictures,
and <span class="c007">neato</span> pictures with explicit placement of the
events of one thread as a colum.
The style is commanded by the <span class="c004">-graph</span> option that accepts three
possible arguments: <span class="c004">cluster</span> (default), <span class="c004">free</span> and&#XA0;<span class="c004">columns</span>.
The following pictures show
the effect of graph styles on the <a href="SB.litmus"><span class="c008">SB</span></a>&#XA0;example:
</p><div class="center">
<table class="c001 cellpading0"><tr><td class="c015"><span class="c004">-graph cluster</span></td><td class="c015"><span class="c004">-graph free</span></td><td class="c015"><span class="c004">-graph columns</span></td></tr>
<tr><td class="c023"><img src="SB+SQUISHED.png"> &#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023"><img src="SB+FREE.png">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023"><img src="SB+COLUMNS.png">
</td></tr>
</table>
</div><p>
Notice that we used another option <span class="c004">-squished true</span> that much reduces
the information displayed in nodes. Also notice that
the first two pictures are formatted by <span class="c007">dot</span>,
while the rightmost picture is formatted by <span class="c007">neato</span>.</p><p>One may also observe that the &#X201C;<span class="c004">-graph columns</span>&#X201D; picture does not
look exactly like Fig.&#XA0;<a href="#fig%3Asb">5</a>. For instance the
<span class="c007">ghb</span> arrows are thicker in the figure.
There are many parameters to control <span class="c007">neato</span> (and&#XA0;<span class="c007">dot</span>),
many of which are accessible to <span class="c007">herd7</span> users by the means of appropriate
options. We do not intend to describe them all.
However, users can reproduce the style of the diagram of this manual using
yet another feature of <span class="c007">herd7</span>: <a href="#herd%3Aconfigfile">configuration files</a>
that contains settings for <span class="c007">herd7</span> options and that are loaded with the
<span class="c004">-conf&#XA0;</span><span class="c010">name</span> option.
In this manual we mostly used the <a href="doc.cfg"><span class="c004">doc.cfg</span></a> configuration file.
As this file is present in <span class="c007">herd7</span> distribution, users
can use the diagram style of this manual:
</p><pre class="verbatim">% herd7 -conf doc.cfg ...
</pre>
<h3 class="subsection" id="show:forbidden">13.2&#XA0;&#XA0;Showing forbidden executions</h3>
<p>
Images are produced or displayed once the model has been executed.
As a consequence,
forbidden executions won&#X2019;t appear by default.
Consider for instance the test <a href="SB+mfences.litmus"><span class="c008">SB+mfences</span></a>,
where the <span class="c004">mfence</span> instruction is used to forbid
<a href="SB.litmus"><span class="c008">SB</span></a> non-SC execution. Runing <span class="c007">herd7</span> as
</p><pre class="verbatim">% herd7 -model tso-02.cat -conf doc.cfg -show prop -gv SB+mfences.litmus
</pre><p>will produce no picture, as the TSO model forbids the target execution
of&#XA0;<span class="c007">SB+mfences</span>.</p><p>To get a picture, we can run <span class="c007">SB+mfences</span> on top of the mininal
model, a pre-defined model that allows all executions:
</p><pre class="verbatim">% herd7 -model minimal -conf doc.cfg -show prop -gv SB+mfences.litmus
</pre><p>And we get the picture:
</p><div class="center"><img src="SB+mfences.png"></div><p>
It is worth mentioning again that although the minimal model allows all
executions, the final condition
selects the displayed picture, as we have specified the
<span class="c004">-show prop</span> option.</p><p><a id="name:check"></a>The picture above shows <code>mfence</code> arrows, as all
fence relations are displayed by the minimal model.
However, it does not show the <code>ghb</code> relation, as the minimal
model knows nothing of it.
To display&#XA0;<code>ghb</code> we could write another model file that would be just as
<a href="tso-02.cat"><span class="c004">tso-02.cat</span></a>, with checks erased.
The simulator <span class="c007">herd7</span> provides a simpler technique:
one can instruct <span class="c007">herd7</span> to ignore
either all checks (<span class="c004">-through invalid</span>), or a selection of checks
(<span class="c004">-skipchecks&#XA0;<span class="c010">name</span></span><sub>1</sub><span class="c004">,&#X2026;,<span class="c010">name</span></span><sub><span class="c010">n</span></sub>).
Thus, either of the following two commands
</p><pre class="verbatim">% herd7 -through invalid -model tso-02.cat -conf doc.cfg -show prop -gv SB+mfences.litmus
% herd7 -skipcheck tso -model tso-02.cat -conf doc.cfg -show prop -gv SB+mfences.litmus
</pre><p>will produce the picture we wish:
</p><div class="center"><img src="SB+mfences+GHB.png"></div><p>
Notice that <code>mfence</code> and&#XA0;<code>ghb</code> are displayed because
of the instruction &#X201C;<code>show mfence ghb</code>&#X201D; (fence relation are not shown
by default);
while <span class="c004">-skipcheck tso</span> works because the <a href="tso-02.cat"><span class="c004">tso-02.cat</span></a> model
names its main check with &#X201C;<code>as tso</code>&#X201D;.</p><p>The image above is barely readable.
For such graphs with many relations, the <code>cluster</code> and&#XA0;<code>free</code> modes
are worth a try. The commands:
</p><pre class="verbatim">% herd7 -skipcheck tso -model tso-02.cat -conf doc.cfg -show prop -graph cluster -gv SB+mfences.litmus
% herd7 -skipcheck tso -model tso-02.cat -conf doc.cfg -show prop -graph free -gv SB+mfences.litmus
</pre><p>will produce the images:
</p><div class="center">
<table class="c001 cellpading0"><tr><td class="c023"><img src="SB+mfences+CLUSTER.png"></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023"><img src="SB+mfences+FREE.png">
</td></tr>
</table>
</div><p>
Namely, command line options are scanned left-to-right,
so that most of the settings of <a href="doc.cfg"><span class="c004">doc.cfg</span></a> are kept<sup><a id="text7" href="#note7">7</a></sup>
(for instance thick <code>ghb</code> arrows), while the graph mode is overriden.</p>
<h2 class="section" id="herd:language">14&#XA0;&#XA0;Model definitions</h2>
<p>We describe our <span class="c004">cat</span>&#XA0;langage for defining models.
The syntax of the language is given in BNF-like notation. Terminal
symbols are set in typewriter font (<span class="c003"><span class="c004">like</span> <span class="c004">this</span></span>).
Non-terminal symbols are set in italic font (<span class="c011">like</span> &#XA0;<span class="c011">that</span>).
An unformatted vertical bar &#X2026;&#X2223; &#X2026;
denotes alternative.
Square brackets [&#X2026;] denote optional components. Curly brackets
{&#X2026;} denotes zero,
one or several repetitions of the enclosed
components.
Parentheses (&#X2026;) denote grouping.</p><p>Model source files may contain comments of the OCaml type
(<code>(*</code>&#X2026;<code>*)</code>, can be nested), or line comments starting with
&#X201C;<code>//</code>&#X201D; and running until end of line.</p>
<h3 class="subsection" id="overview">14.1&#XA0;&#XA0;Overview</h3>
<p>
The <span class="c004">cat</span> language is much inspired by OCaml, featuring immutable bindings,
first-class functions, pattern matching, etc.
However, <span class="c004">cat</span> is a domain specific language, with important differences
from OCaml.
</p><ol class="enumerate" type=1><li class="li-enumerate">
Base values are specialised, they are sets of events and relations
over events. There are also tags, akin to C&#XA0;enumerations or OCaml
&#X201C;constant&#X201D; constructors and first class functions. 
There are two structured values: tuples of values and sets of values.
</li><li class="li-enumerate">There is a distinction between expressions that evaluate
to some value, and instructions that are executed for their effect.
</li></ol><p>
A model, or <span class="c004">cat</span> program is a sequence of instructions.
At startup, pre-defined identifiers are bound to event sets and relations
over events.
Those pre-defined identifiers describe a candidate execution
(in the sense of the memory model).
Executing the model means allowing or forbiding that candidate
execution.</p>
<h3 class="subsection" id="language:identifier">14.2&#XA0;&#XA0;Identifiers</h3>
<table class="display dcenter"><tr class="c020"><td class="dcell"><table class="c001 cellpading0"><tr><td class="c019">
<a class="syntax" id="letter"><span class="c011">letter</span></a>&#XA0;</td><td class="c015">::=</td><td class="c017">&#XA0;<span class="c005">a</span>&#XA0;&#X2026;&#XA0;<span class="c005">z</span>
&#X2223;&#XA0;&#XA0;&#XA0;<span class="c005">A</span>&#XA0;&#X2026;&#XA0;<span class="c005">Z</span>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td></tr>
<tr><td class="c019">
<a class="syntax" id="digit"><span class="c011">digit</span></a>&#XA0;</td><td class="c015">::=</td><td class="c017">&#XA0;<span class="c005">0</span>&#XA0;&#X2026;&#XA0;<span class="c005">9</span>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td></tr>
<tr><td class="c019">
<a class="syntax" id="id"><span class="c011">id</span></a>&#XA0;</td><td class="c015">::=</td><td class="c017">&#XA0;<a class="syntax" href="#letter"><span class="c011">letter</span></a>&#XA0;&#XA0;{&#XA0;<a class="syntax" href="#letter"><span class="c011">letter</span></a>&#XA0;&#X2223;&#XA0;&#XA0;<a class="syntax" href="#digit"><span class="c011">digit</span></a>
&#X2223;&#XA0;&#XA0;<span class="c005">_</span>&#XA0;&#X2223;&#XA0;&#XA0;<span class="c005">.</span>&#XA0;&#X2223;&#XA0;&#XA0;<span class="c005">-</span>&#XA0;}
</td></tr>
</table></td></tr>
</table><p>
Identifiers are rather standard: they are a sequence of letters, digits,
&#X201C;<span class="c004">_</span>&#X201D; (the underscore character), &#X201C;<span class="c004">.</span>&#X201D; (the dot character)
and &#X201C;<span class="c004">-</span>&#X201D; (the minus character),
starting with a letter.
Using the minus character inside identifiers may look a bit surprising.
We did so as to allow identifiers such as <span class="c004">po-loc</span>.</p><p><a id="sec:predef"></a>At startup, pre-defined identifiers are bound to
event sets and to relations
between events.</p><p>Those pre-defined identifiers first describe the events of
the candidate execution as various sets, as described by the first table
of figure&#XA0;<a href="#predefset">6</a>.
</p><blockquote class="figure"><div class="center"><hr class="c026"></div>
<div class="caption"><table class="c001 cellpading0"><tr><td class="c023">Figure 6: <a id="predefset"></a>Pre-defined event sets.</td></tr>
</table></div>
<div class="showcenter">
<table class="c001 cellpading0"><tr><td class="c015" colspan=2>identifier</td><td class="c015" colspan=2>name</td><td class="c015">description
</td></tr>
<tr><td class="hbar" colspan=5></td></tr>
<tr><td class="c025"><span class="c007">W</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">write events </td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td></tr>
<tr><td class="c025"><span class="c007">R</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">read events </td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td></tr>
<tr><td class="c025"><span class="c007">M</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">memory events</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">we have <span class="c007">M</span> = <span class="c007">W</span> &#X222A; <span class="c007">R</span></td></tr>
<tr><td class="c025"><span class="c007">IW</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">initial writes</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">feed reads that read from the initial state</td></tr>
<tr><td class="c025"><span class="c007">FW</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">final writes</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">writes that are observed at the end of test execution</td></tr>
<tr><td class="c025"><span class="c007">B</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">branch events</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td></tr>
<tr><td class="c025"><span class="c007">RMW</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">read-modify-write events</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td></tr>
<tr><td class="c025"><span class="c007">F</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">fence events</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td></tr>
<tr><td class="c025"><span class="c010">NAME</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">specific fence events</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">those depend on the test architecture</td></tr>
</table></div><div class="showcenter">
<table class="c001 cellpading0"><tr><td class="c015" colspan=2>architecture</td><td class="c015">fence sets
</td></tr>
<tr><td class="hbar" colspan=3></td></tr>
<tr><td class="c025"><span class="c007">X86</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023"><span class="c007">MFENCE</span>, <span class="c007">SFENCE</span>, <span class="c007">LFENCE</span></td></tr>
<tr><td class="c025"><span class="c007">PPC</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023"><span class="c007">SYNC</span>, <span class="c007">LWSYNC</span>, <span class="c007">EIEIO</span>, <span class="c007">ISYNC</span></td></tr>
<tr><td class="c025"><span class="c007">ARM</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023"><span class="c007">DMB</span>, <span class="c007">DMB.ST</span>, <span class="c007">DSB</span>, <span class="c007">DSB.ST</span>, <span class="c007">ISB</span></td></tr>
<tr><td class="c025"> <span class="c007">MIPS</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023"><span class="c007">SYNC</span></td></tr>
<tr><td class="c025"><span class="c007">AArch64</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">&#X2026;</td></tr>
</table></div><div class="center"><hr class="c026"></div></blockquote><p>
Specific fence event sets depends on the test architecture,
their name is always uppercase and derive from the mnemonic of
the instruction that generates them.
The second table of figure&#XA0;<a href="#predefset">6</a> shows
a (non-exhaustive) list.</p><p>Other pre-defined identifiers are relations.
Most of those are the program order&#XA0;<span class="c004">po</span> and its refinements:
</p><div class="showcenter">
<table class="c001 cellpading0"><tr><td class="c015" colspan=2>identifier</td><td class="c015" colspan=2>name</td><td class="c015">description
</td></tr>
<tr><td class="hbar" colspan=5></td></tr>
<tr><td class="c025"><span class="c004">po</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">program order</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">instruction order lifted to events </td></tr>
<tr><td class="c025"><span class="c004">addr</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">address dependency</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">the address of the second event depends on
the value loaded by the first (read) event</td></tr>
<tr><td class="c025"><span class="c004">data</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">data dependency</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">the value stored by the second (write)
event depends on
the value loaded by the first (read) event</td></tr>
<tr><td class="c025"><span class="c004">ctrl</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">control dependency</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">the second event is in a branch controled by the value loaded by the
commfirst (read) event</td></tr>
<tr><td class="c025"><span class="c004">rmw</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">read-exclusive write-exclusive pair</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">relate the read and write events emitted
by matching successful load-reserve store conditional instructions.
</td></tr>
</table></div><p>Finally, a few pre-defined relations describe the execution
candidate structure and write-to-read communication:
</p><div class="showcenter">
<table class="c001 cellpading0"><tr><td class="c015" colspan=2>identifier</td><td class="c015" colspan=2>name</td><td class="c015">description
</td></tr>
<tr><td class="hbar" colspan=5></td></tr>
<tr><td class="c025"><span class="c004">id</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">identity</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">relates each event to itself</td></tr>
<tr><td class="c025"><span class="c004">loc</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">same location</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">events that touch the same address</td></tr>
<tr><td class="c025"><span class="c004">ext</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">external</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">events from different threads</td></tr>
<tr><td class="c025"><span class="c004">int</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">internal</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">events from the same thread</td></tr>
<tr><td class="c025">
<span class="c004">rf</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">read-from</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">links a write <span class="c010">w</span> to a read <span class="c010">r</span> taking its value from <span class="c010">w</span> </td></tr>
</table></div><p>Some additional relations are defined by library files written in the <span class="c004">cat</span>
language, see Sec.&#XA0;<a href="#sec%3Alibrary">14.7</a>.</p>
<h3 class="subsection" id="language:expression">14.3&#XA0;&#XA0;Expressions</h3>
<p>
Expressions are evaluated by <span class="c007">herd7</span>, yielding a value.
</p><table class="display dcenter"><tr class="c020"><td class="dcell"><table class="c001 cellpading0"><tr><td class="c019">
<a class="syntax" id="expr"><span class="c011">expr</span></a>&#XA0;</td><td class="c015">::=</td><td class="c017">&#XA0;<span class="c005">0</span>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td><td class="c015">&#X2223;</td><td class="c017">&#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td><td class="c015">&#X2223;</td><td class="c017">&#XA0;<a class="syntax" href="#tag"><span class="c011">tag</span></a>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td><td class="c015">&#X2223;</td><td class="c017">&#XA0;<span class="c005">(</span>&#XA0;<span class="c005">)</span>&#XA0;&#X2223;&#XA0;&#XA0;<span class="c005">(</span>&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;&#XA0;<span class="c005">,</span>&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;&#XA0;{&#XA0;<span class="c005">,</span>&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;}&#XA0;&#XA0;<span class="c005">)</span>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td><td class="c015">&#X2223;</td><td class="c017">&#XA0;<span class="c005">{</span>&#XA0;<span class="c005">}</span>&#XA0;&#X2223;&#XA0;&#XA0;<span class="c005">{</span>&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;&#XA0;{&#XA0;<span class="c005">,</span>&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;}&#XA0;&#XA0;<span class="c005">}</span>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td><td class="c015">&#X2223;</td><td class="c017">&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;<span class="c005">*</span>&#XA0;&#X2223;&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;<span class="c005">+</span>&#XA0;&#X2223;&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;<span class="c005">?</span>
&#X2223;&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;<span class="c005">^-1</span>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td><td class="c015">&#X2223;</td><td class="c017">&#XA0;<span class="c005">~</span>&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td><td class="c015">&#X2223;</td><td class="c017">&#XA0;<span class="c005">[</span>&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;<span class="c005">]</span>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td><td class="c015">&#X2223;</td><td class="c017">&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;<span class="c005">|</span>&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;&#X2223;&#XA0;
<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;<span class="c005">++</span>&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;&#X2223;&#XA0;
<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;<span class="c005">;</span>&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;&#X2223;&#XA0;
<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;<span class="c005">\</span>&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;&#X2223;&#XA0;
<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;<span class="c005">&amp;</span>&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;&#X2223;&#XA0;
<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;&#XA0;<span class="c005">*</span>&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td><td class="c015">&#X2223;</td><td class="c017">&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td><td class="c015">&#X2223;</td><td class="c017">&#XA0;<span class="c005">fun</span>&#XA0;&#XA0;<a class="syntax" href="#pat"><span class="c011">pat</span></a>&#XA0;&#XA0;<span class="c005">-&gt;</span>&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td><td class="c015">&#X2223;</td><td class="c017">&#XA0;<span class="c005">let</span>&#XA0;&#XA0;[&#XA0;<span class="c005">rec</span>&#XA0;]&#XA0;&#XA0;<a class="syntax" href="#binding"><span class="c011">binding</span></a>&#XA0;&#XA0;{&#XA0;<span class="c005">and</span>&#XA0;&#XA0;<a class="syntax" href="#binding"><span class="c011">binding</span></a>&#XA0;}&#XA0;&#XA0;<span class="c005">in</span>&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td><td class="c015">&#X2223;</td><td class="c017">&#XA0;<span class="c005">match</span>&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;&#XA0;<span class="c005">with</span>&#XA0;&#XA0;<a class="syntax" href="#clauses"><span class="c011">clauses</span></a>&#XA0;&#XA0;<span class="c005">end</span>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td><td class="c015">&#X2223;</td><td class="c017">&#XA0;<span class="c005">(</span>&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;<span class="c005">)</span>&#XA0;&#X2223;&#XA0;&#XA0;&#XA0;<span class="c005">begin</span>&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;&#XA0;<span class="c005">end</span>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td><td class="c015">&#X2223;</td><td class="c017">&#XA0;<span class="c005">instructions</span>&#XA0;&#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a>&#XA0;<span class="c011">[taglist]</span>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td></tr>
<tr><td class="c019">
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td></tr>
<tr><td class="c019">
<a class="syntax" id="tag"><span class="c011">tag</span></a>&#XA0;</td><td class="c015">::=</td><td class="c017">&#XA0;<span class="c005">&#X2019;</span>&#XA0;&#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td></tr>
<tr><td class="c019">
<a class="syntax" id="taglist"><span class="c011">taglist</span></a>&#XA0;</td><td class="c015">::=</td><td class="c017">&#XA0;<span class="c011">tag, taglist</span>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td></tr>
<tr><td class="c019">
<a class="syntax" id="pat"><span class="c011">pat</span></a>&#XA0;</td><td class="c015">::=</td><td class="c017">&#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a>&#XA0;&#X2223;&#XA0;&#XA0;<span class="c005">(</span>&#XA0;<span class="c005">)</span>&#XA0;&#X2223;&#XA0;&#XA0;<span class="c005">(</span>&#XA0;&#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a>&#XA0;&#XA0;{&#XA0;<span class="c005">,</span>&#XA0;&#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a>&#XA0;}&#XA0;&#XA0;<span class="c005">)</span>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td></tr>
<tr><td class="c019">
<a class="syntax" id="binding"><span class="c011">binding</span></a>&#XA0;</td><td class="c015">::=</td><td class="c017">&#XA0;<a class="syntax" href="#valbinding"><span class="c011">valbinding</span></a>&#XA0;&#X2223;&#XA0;&#XA0;<a class="syntax" href="#funbinding"><span class="c011">funbinding</span></a>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td></tr>
<tr><td class="c019">
<a class="syntax" id="valbinding"><span class="c011">valbinding</span></a>&#XA0;</td><td class="c015">::=</td><td class="c017">&#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a>&#XA0;&#XA0;<span class="c005">=</span>&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td></tr>
<tr><td class="c019">
<a class="syntax" id="funbinding"><span class="c011">funbinding</span></a>&#XA0;</td><td class="c015">::=</td><td class="c017">&#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a>&#XA0;&#XA0;<a class="syntax" href="#pat"><span class="c011">pat</span></a>&#XA0;&#XA0;<span class="c005">=</span>&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td></tr>
<tr><td class="c019">
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td></tr>
<tr><td class="c019">
<a class="syntax" id="clauses"><span class="c011">clauses</span></a>&#XA0;</td><td class="c015">::=</td><td class="c017">&#XA0;<a class="syntax" href="#tagclauses"><span class="c011">tagclauses</span></a>&#XA0;&#X2223;&#XA0;&#XA0;<a class="syntax" href="#setclauses"><span class="c011">setclauses</span></a>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td></tr>
<tr><td class="c019">
<a class="syntax" id="tagclauses"><span class="c011">tagclauses</span></a>&#XA0;</td><td class="c015">::=</td><td class="c017">&#XA0;[&#XA0;<span class="c005">||</span>&#XA0;]&#XA0;&#XA0;<a class="syntax" href="#tag"><span class="c011">tag</span></a>&#XA0;&#XA0;<span class="c005">-&gt;</span>&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>
&#XA0;{&#XA0;<span class="c005">||</span>&#XA0;&#XA0;<a class="syntax" href="#tag"><span class="c011">tag</span></a>&#XA0;&#XA0;<span class="c005">-&gt;</span>&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;}
&#XA0;[&#XA0;<span class="c005">_</span>&#XA0;&#XA0;<span class="c005">-&gt;</span>&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;]
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td></tr>
<tr><td class="c019">
<a class="syntax" id="setclauses"><span class="c011">setclauses</span></a>&#XA0;</td><td class="c015">::=</td><td class="c017">&#XA0;[&#XA0;<span class="c005">||</span>&#XA0;]&#XA0;&#XA0;<span class="c005">{</span>&#XA0;<span class="c005">}</span>&#XA0;&#XA0;<span class="c005">-&gt;</span>&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>
&#XA0;<span class="c005">||</span>&#XA0;&#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a>&#XA0;&#XA0;<span class="c005">++</span>&#XA0;&#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a>&#XA0;&#XA0;<span class="c005">-&gt;</span>&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>
</td></tr>
</table></td></tr>
</table><h4 class="subsubsection" id="sec81">Simple expressions</h4>
<p>
Simple expressions are the empty relation (keyword&#XA0;<span class="c005">0</span>),
identifiers&#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a> and tags&#XA0;<a class="syntax" href="#tag"><span class="c011">tag</span></a>. Identifiers are bound to
values, either before the execution (see pre-defined identifiers in
Sec.&#XA0;<a href="#sec%3Apredef">14.2</a>), or by the model itself. Tags are constants similar to
C enum values or OCaml constant constructors. Tags must be declared with the
<span class="c005">enum</span> instruction. We go back to <span class="c005">enum</span> and tags in Sec.&#XA0;<a href="#sec%3Aenum">14.4</a>
and <a >??</a>.</p><h4 class="subsubsection" id="sec82">Tuples</h4>
<p>
Tuples include a constant, the empty tuple <span class="c005">()</span>,
and constructed tuples
<span class="c005">(</span> <a class="syntax" href="#expr"><span class="c011">expr</span></a><sub>1</sub> <span class="c005">,</span> &#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a><sub>1</sub> <span class="c005">,</span>&#X2026; <span class="c005">,</span> &#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a><sub><span class="c010">n</span></sub><span class="c005">)</span>,
with <span class="c010">n</span> &#X2265; 2. In other words there is no tuple of size one.
Syntax <span class="c005">(</span> <a class="syntax" href="#expr"><span class="c011">expr</span></a> <span class="c005">)</span> denotes grouping and has the same
value as&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>.</p><h4 class="subsubsection" id="sec83">Explicit sets of values</h4>
<p>
Explicit sets are written as the comma separated
list of their elements between curly braces:
<span class="c005">{</span> <a class="syntax" href="#expr"><span class="c011">expr</span></a><sub>1</sub> <span class="c005">,</span> &#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a><sub>1</sub> <span class="c005">,</span>&#X2026; <span class="c005">,</span> &#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a><sub><span class="c010">n</span></sub><span class="c005">}</span>,
with <span class="c010">n</span> &#X2265; 0.
As events are not values, one cannot build a set of events using
explicit set expressions.
However, by exception, the empty set&#XA0;<span class="c005">{}</span>
also is the empty set of events and the empty relation.
Sets are homogenous, in the sense that sets hold elements of the same type.</p><h4 class="subsubsection" id="sec84">Operator expressions</h4>
<p>
The transitive and reflexive-transitive closure of an expression are performed
by the postfix operators <span class="c005">+</span> and&#XA0;<span class="c005">*</span>.
The postfix operator <span class="c005">^-1</span> performs relation inversion.
The construct <a class="syntax" href="#expr"><span class="c011">expr</span></a><span class="c005">?</span> (option) evaluates to the union
of <a class="syntax" href="#expr"><span class="c011">expr</span></a> value and of the identity relation.
Notice that postfix operators operate on relations only.</p><p>There is one prefix operator&#XA0;<span class="c005">~</span> that performs
relation and set complement.</p><p>Finally, there is one last unary operator: <span class="c005">[</span><a class="syntax" href="#expr"><span class="c011">expr</span></a><span class="c005">]</span>
that evaluate <a class="syntax" href="#expr"><span class="c011">expr</span></a> to an event set and returns the identity
relation over this set.</p><p>Infix operators are
<span class="c005">|</span> (union), <span class="c005">++</span> (set addition),
<span class="c005">;</span> (sequence), <span class="c005">&amp;</span> (intersection), <span class="c005">\</span> (set difference),
and&#XA0;<span class="c005">*</span> (cartesian product).
Infix operators are listed in order of decreasing precedence,
while postfix and prefix operators bind tighter than infix operators.
All infix operators are right-associative,
except set difference which is left-associative, and cartesian product
which is non-associative.</p><p>The union, intersection and difference operators apply to relations
and all kinds of sets.
The addition operator <a class="syntax" href="#expr"><span class="c011">expr</span></a><sub>1</sub> <span class="c005">++</span> &#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a><sub>2</sub> operates on
sets: the value of <a class="syntax" href="#expr"><span class="c011">expr</span></a><sub>2</sub> must be a set of values
&#XA0;<span class="c010">S</span> and the operator returns the set&#XA0;<span class="c010">S</span> augmented with the value of
<a class="syntax" href="#expr"><span class="c011">expr</span></a><sub>1</sub>.</p><p>For the record, given two relations <span class="c010">r</span><sub>1</sub> and&#XA0;<span class="c010">r</span><sub>2</sub>,
the sequence <span class="c010">r</span><sub>1</sub>; <span class="c010">r</span><sub>2</sub> is defined
as { (<span class="c010">x</span>,<span class="c010">y</span>) &#X2223; &#X2203; <span class="c010">z</span>, (<span class="c010">x</span>,<span class="c010">z</span>) &#X2208; <span class="c010">r</span><sub>1</sub> &#X2227; (<span class="c010">z</span>,<span class="c010">y</span>) &#X2208; <span class="c010">r</span><sub>2</sub>}.</p><h4 class="subsubsection" id="sec85">Function calls</h4>
<p>
Functions calls are written <a class="syntax" href="#expr"><span class="c011">expr</span></a><sub>1</sub> &#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a><sub>2</sub>.
That is, functions are of arity one and the application operator
is left implicit. Notice that function application binds tighter
than all binary operators and looser that postfix operators.
Furthermore the implicit application operator is left-associative.</p><p>The <span class="c004">cat</span> language has call-by-value semantics. That is,
the effective parameter
<a class="syntax" href="#expr"><span class="c011">expr</span></a><sub>2</sub> is evaluated before being bound to the
function formal parameter(s).</p><p>N-ary functions can be encoded either using tuples as arguments
or by curryfication (<em>i.e.</em> as functions that return functions).
Considering binary functions, in the former case,
a function call is written
<a class="syntax" href="#expr"><span class="c011">expr</span></a><sub>1</sub> <span class="c005">(</span> &#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a><sub>2</sub> <span class="c005">,</span> &#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a><sub>3</sub><span class="c005">)</span>;
while in the latter case, a function call is written
<a class="syntax" href="#expr"><span class="c011">expr</span></a><sub>1</sub>&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a><sub>2</sub>&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a><sub>3</sub>
(which by left-associativity, is to be understood
as <span class="c005">(</span><a class="syntax" href="#expr"><span class="c011">expr</span></a><sub>1</sub>&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a><sub>2</sub><span class="c005">)</span>&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a><sub>3</sub>).
The two forms of function call are not interchangeable, using one or the
other depends on the definition of the function.</p><h4 class="subsubsection" id="sec86">Functions</h4>
<p>
Functions are first class values, as reflected by the anonymous
function construct <span class="c005">fun</span> <a class="syntax" href="#pat"><span class="c011">pat</span></a> <span class="c005">-&gt;</span> &#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>.
A function takes one argument only.</p><p>In the case where this argument is a tuple, it may be destructured
by the means of a tuple pattern. That is <a class="syntax" href="#pat"><span class="c011">pat</span></a>
above is <span class="c005">(</span> <a class="syntax" href="#id"><span class="c011">id</span></a><sub>1</sub> <span class="c005">,</span> &#X2026; &#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a><sub><span class="c010">n</span></sub><span class="c005">)</span>.
For instance here is a function that takes a tuple of
relations (or sets) as argument and return their symmetric difference:
</p><pre class="verbatim">fun (a,b) -&gt; (a\b)|(b\a)
</pre><p>Functions have the usual static scoping semantics:
variables that appear free in function bodies 
(<a class="syntax" href="#expr"><span class="c011">expr</span></a> above) are bound to
the value of such free variable at function creation time.
As a result one may also write the symmetric difference function
as follows:
</p><pre class="verbatim">fun a -&gt; fun b -&gt; (a\b)|(b\a)
</pre><h4 class="subsubsection" id="bindings">Local bindings</h4>
<p>
The local binding construct
<span class="c005">let</span> [ <span class="c005">rec</span> ] <span class="c011">bindings</span> <span class="c005">in</span> <a class="syntax" href="#expr"><span class="c011">expr</span></a>
binds the names defined by <span class="c011">bindings</span> 
for evaluating the expression &#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>.
Both non-recursive and recursive bindings are allowed.
The function binding
<a class="syntax" href="#id"><span class="c011">id</span></a> &#XA0;<a class="syntax" href="#pat"><span class="c011">pat</span></a> <span class="c005">=</span> &#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a> is syntactic sugar
for <a class="syntax" href="#id"><span class="c011">id</span></a> <span class="c003"><span class="c004">=</span> <span class="c004">fun</span></span> &#XA0;<a class="syntax" href="#pat"><span class="c011">pat</span></a> <span class="c005">-&gt;</span> &#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>.</p><p>The construct
</p><div class="center">
<span class="c005">let</span> <a class="syntax" href="#pat"><span class="c011">pat</span></a><sub>1</sub> <span class="c005">=</span> &#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a><sub>1</sub> <span class="c005">and</span> &#X2026; <span class="c005">and</span> &#XA0;<a class="syntax" href="#pat"><span class="c011">pat</span></a><sub><span class="c010">n</span></sub> <span class="c005">=</span> &#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a><sub><span class="c010">n</span></sub> <span class="c005">in</span> &#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>
</div><p>
evaluates <span class="c011">expr</span><sub>1</sub>,&#X2026;, <span class="c011">expr</span><sub><span class="c010">n</span></sub>,
and binds the names in the patterns
<span class="c011">pat</span><sub>1</sub>,&#X2026;, <span class="c011">pat</span><sub><span class="c010">n</span></sub> to the resulting values.
The bindings for <span style="color:maroon"><span class="c010">pat</span> <span class="c005">=</span> <span class="c010">expr</span></span> are as follows:
if <span class="c011">pat</span> is <span class="c005">()</span>, then <span class="c011">expr</span> must evaluate to the empty
tuple;
if <span class="c011">pat</span> is <span class="c011">id</span> or <span class="c003"><span class="c004">(</span><span class="c011">id</span><span class="c004">)</span></span>,
then <span class="c011">id</span> is bound to the value of&#XA0;<span class="c011">expr</span>;
if <span class="c011">pat</span> is a proper tuple pattern
<span class="c005">(</span><span class="c011">id</span><sub>1</sub><span class="c005">,</span>&#X2026; <span class="c005">,</span><span class="c011">id</span><sub><span class="c010">n</span></sub><span class="c005">)</span> with <span class="c010">n</span> &#X2265; 2,
then <span class="c011">expr</span> must evaluate to a tuple value of size&#XA0;<span class="c010">n</span>
(<span class="c010">v</span><sub>1</sub>,&#X2026;,<span class="c010">v</span><sub><span class="c010">n</span></sub>) and the names <span class="c011">id</span><sub>1</sub>,&#X2026;,<span class="c011">id</span><sub><span class="c010">n</span></sub> are
bound to the values <span class="c010">v</span><sub>1</sub>,&#X2026;,<span class="c010">v</span><sub><span class="c010">n</span></sub>.</p><p><a id="letrec">The</a> construct
</p><div class="center">
<span class="c003"><span class="c004">let</span> <span class="c004">rec</span></span> <a class="syntax" href="#pat"><span class="c011">pat</span></a><sub>1</sub> <span class="c005">=</span> &#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a><sub>1</sub> <span class="c005">and</span> &#X2026; <span class="c005">and</span> &#XA0;<a class="syntax" href="#pat"><span class="c011">pat</span></a><sub><span class="c010">n</span></sub> <span class="c005">=</span> &#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a><sub><span class="c010">n</span></sub> <span class="c005">in</span> &#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>
</div><p>
computes the least fixpoint of the equations
<span class="c011">pat</span><sub>1</sub> = <span class="c011">expr</span><sub>1</sub>,&#X2026;, <span class="c011">pat</span><sub><span class="c010">n</span></sub> = <span class="c011">expr</span><sub><span class="c010">n</span></sub>.
It then binds the names in the patterns
<span class="c011">pat</span><sub>1</sub>,&#X2026;, <span class="c011">pat</span><sub><span class="c010">n</span></sub> to the
resulting values.
The least fixpoint computation applies to set and relation values,
(using inclusion for ordering); and to
functions (using the usual definition ordering).</p><h4 class="subsubsection" id="sec88">Pattern matching over tags</h4>
<p>
The syntax for pattern matching over tags is:
</p><div class="center">
<span class="c005">match</span> <a class="syntax" href="#expr"><span class="c011">expr</span></a> <span class="c005">with</span> &#XA0;<a class="syntax" href="#tag"><span class="c011">tag</span></a><sub>1</sub> <span class="c005">-&gt;</span> &#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a><sub>1</sub>
<span class="c005">||</span> &#X22EF; <span class="c005">||</span> &#XA0;<a class="syntax" href="#tag"><span class="c011">tag</span></a><sub><span class="c010">n</span></sub> <span class="c005">-&gt;</span> &#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a><sub><span class="c010">n</span></sub>
<span class="c003"><span class="c004">||</span> <span class="c004">_</span> <span class="c004">-&gt;</span></span> &#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a><sub><span class="c010">d</span></sub>
<span class="c005">end</span>
</div><p>
The value of the match expression is computed as follow: first evaluate
<span class="c011">expr</span> to some value&#XA0;<span class="c010">v</span>, which must be a tag&#XA0;<span class="c010">t</span>.
Then <span class="c010">v</span> is compared with the tags <span class="c011">tag</span><sub>1</sub>,&#X2026;,<span class="c011">tag</span><sub><span class="c010">n</span></sub>,
in that order.
If some tag pattern&#XA0;<span class="c011">tag</span><sub><span class="c010">i</span></sub> equals&#XA0;<span class="c010">t</span>, then the value of the
match is the value of the corresponding expression&#XA0;<span class="c011">expr</span><sub><span class="c010">i</span></sub>.
Otherwise, the value of the match is the value of the default
expression&#XA0;<span class="c011">expr</span><sub><span class="c010">d</span></sub>.
As the default clause&#XA0;<span class="c003"><span class="c004">_</span> <span class="c004">-&gt;</span></span> <a class="syntax" href="#expr"><span class="c011">expr</span></a><sub><span class="c010">d</span></sub> is optional,
the match construct may fail.</p><h4 class="subsubsection" id="sec89">Pattern matching over sets</h4>
<p>
The syntax for pattern matching over sets is:
</p><div class="center">
<span class="c005">match</span> <a class="syntax" href="#expr"><span class="c011">expr</span></a> <span class="c003"><span class="c004">with</span>
<span class="c004">{}</span> <span class="c004">-&gt;</span></span> &#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a><sub>1</sub>
<span class="c005">||</span> &#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a><sub>1</sub> <span class="c005">++</span> &#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a><sub>2</sub> <span class="c005">-&gt;</span> &#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a><sub>2</sub>
<span class="c005">end</span>
</div><p>
The value of the match expression is computed as follow: first evaluate
<span class="c011">expr</span> to some value&#XA0;<span class="c010">v</span>, which must be a set of values.
If <span class="c010">v</span> is the empty set, that the value of the match is the
value of the corresponding expression&#XA0;<span class="c011">expr</span><sub>1</sub>.
Otherwise, <span class="c010">v</span> is a non-empty set, then let <span class="c010">v</span><sub><span class="c010">e</span></sub> be some element in&#XA0;<span class="c010">v</span>
and <span class="c010">v</span><sub><span class="c010">r</span></sub> be the set&#XA0;<span class="c010">v</span> minus the element&#XA0;<span class="c010">v</span><sub><span class="c010">e</span></sub>.
The value of the match is the value of <span class="c011">expr</span><sub>2</sub> in a context
where <span class="c011">id</span><sub>1</sub> is bound to&#XA0;<span class="c010">v</span><sub><span class="c010">e</span></sub> and <span class="c011">id</span><sub>2</sub> is bound
to&#XA0;<span class="c010">v</span><sub><span class="c010">r</span></sub>.</p><h4 class="subsubsection" id="sec90">Parenthesised expressions</h4>
<p>
The expression <span class="c005">(</span><a class="syntax" href="#expr"><span class="c011">expr</span></a><span class="c005">)</span>
has the same value as <a class="syntax" href="#expr"><span class="c011">expr</span></a>.
Notice that a parenthesised expression
can also be written as <span class="c005">begin</span> <a class="syntax" href="#expr"><span class="c011">expr</span></a> <span class="c005">end</span>.</p>
<h3 class="subsection" id="language:instruction">14.4&#XA0;&#XA0;Instructions</h3>
<p>
Instruction are executed for their effect.
There are three kinds of effects: adding new bindings,
checking a condition, and specifying relations that are shown in pictures.
</p><table class="display dcenter"><tr class="c020"><td class="dcell"><table class="c001 cellpading0"><tr><td class="c019">
<a class="syntax" id="instruction"><span class="c011">instruction</span></a>&#XA0;</td><td class="c015">::=</td><td class="c017">&#XA0;&#XA0;<span class="c005">let</span>&#XA0;&#XA0;[&#XA0;<span class="c005">rec</span>&#XA0;]&#XA0;&#XA0;<a class="syntax" href="#binding"><span class="c011">binding</span></a>&#XA0;&#XA0;{&#XA0;<span class="c005">and</span>&#XA0;&#XA0;<a class="syntax" href="#binding"><span class="c011">binding</span></a>&#XA0;}
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td><td class="c015">&#X2223;</td><td class="c017">&#XA0;[&#XA0;<span class="c005">flag</span>&#XA0;]&#XA0;&#XA0;<a class="syntax" href="#check"><span class="c011">check</span></a>&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;&#XA0;[&#XA0;<span class="c005">as</span>&#XA0;&#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a>]
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td><td class="c015">&#X2223;</td><td class="c017">&#XA0;<span class="c005">enum</span>&#XA0;&#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a>&#XA0;&#XA0;<span class="c005">=</span>&#XA0;&#XA0;[&#XA0;<span class="c005">||</span>&#XA0;&#XA0;<a class="syntax" href="#tag"><span class="c011">tag</span></a>
&#XA0;{&#XA0;<span class="c005">||</span>&#XA0;&#XA0;<a class="syntax" href="#tag"><span class="c011">tag</span></a>&#XA0;}
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td><td class="c015">&#X2223;</td><td class="c017">&#XA0;<span class="c005">procedure</span>&#XA0;&#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a>&#XA0;&#XA0;<a class="syntax" href="#pat"><span class="c011">pat</span></a>&#XA0;&#XA0;<span class="c005">=</span>&#XA0;&#XA0;{&#XA0;<a class="syntax" href="#instruction"><span class="c011">instruction</span></a>&#XA0;}&#XA0;&#XA0;<span class="c005">end</span>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td><td class="c015">&#X2223;</td><td class="c017">&#XA0;<span class="c005">call</span>&#XA0;&#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a>&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;&#XA0;&#XA0;[&#XA0;<span class="c005">as</span>&#XA0;&#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a>]
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td><td class="c015">&#X2223;</td><td class="c017">&#XA0;<span class="c005">show</span>&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;&#XA0;<span class="c005">as</span>&#XA0;&#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td><td class="c015">&#X2223;</td><td class="c017">&#XA0;<span class="c005">show</span>&#XA0;&#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a>&#XA0;&#XA0;{&#XA0;<span class="c005">,</span>&#XA0;&#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a>&#XA0;}
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td><td class="c015">&#X2223;</td><td class="c017">&#XA0;<span class="c005">unshow</span>&#XA0;&#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a>&#XA0;&#XA0;{&#XA0;<span class="c005">,</span>&#XA0;&#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a>&#XA0;}
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td><td class="c015">&#X2223;</td><td class="c017">&#XA0;<span class="c005">forall</span>&#XA0;&#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a>&#XA0;&#XA0;<span class="c005">in</span>&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>&#XA0;&#XA0;<span class="c005">do</span>&#XA0;&#XA0;{&#XA0;<a class="syntax" href="#instruction"><span class="c011">instruction</span></a>&#XA0;}&#XA0;&#XA0;<span class="c005">end</span>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td><td class="c015">&#X2223;</td><td class="c017">&#XA0;<span class="c005">with</span>&#XA0;&#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a>&#XA0;&#XA0;<span class="c005">from</span>&#XA0;&#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td><td class="c015">&#X2223;</td><td class="c017">&#XA0;<span class="c005">include</span>&#XA0;<span class="c011">string</span>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td></tr>
<tr><td class="c019">
<a class="syntax" id="check"><span class="c011">check</span></a>&#XA0;</td><td class="c015">::=</td><td class="c017">&#XA0;<a class="syntax" href="#checkname"><span class="c011">checkname</span></a>&#XA0;&#X2223;&#XA0;&#XA0;<span class="c005">~</span>&#XA0;&#XA0;<a class="syntax" href="#checkname"><span class="c011">checkname</span></a>
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td></tr>
<tr><td class="c019">
<a class="syntax" id="checkname"><span class="c011">checkname</span></a>&#XA0;</td><td class="c015">::=</td><td class="c017">&#XA0;<span class="c005">acyclic</span>&#XA0;&#X2223;&#XA0;&#XA0;<span class="c005">irreflexive</span>&#XA0;&#X2223;&#XA0;&#XA0;<span class="c005">empty</span>
</td></tr>
</table></td></tr>
</table><h4 class="subsubsection" id="sec92">Bindings</h4>
<p>
The <span class="c005">let</span> and <span class="c005">let</span>&#XA0;<span class="c005">rec</span> constructs bind value names for the rest
of model execution.
See the subsection on <a href="#bindings">bindings</a>
in Section&#XA0;<a href="#language%3Aexpression">14.3</a>
for additional information on the syntax and semantics of bindings.</p><p>Recursive definitions computes fixpoints of relations.
For instance, the following fragment computes the transitive closure of
all communication relations:
</p><pre class="verbatim">let com = rf | co | fr
let rec complus = com | (complus ; complus)
</pre><p>Notice that the instruction <code>let complus = (rf|co|fr)+</code> is equivalent.
Notice that <span class="c007">herd7</span> assumes that recursive definitions are well-formed,
<em>i.e.</em> that they yield an increasing functional.
The result of ill-formed definitions is undefined.</p><p>Although <span class="c007">herd7</span> features recursive functions, those cannot be used
to compute a transitive closure, due to the lack of some construct
say to test relation equality. Nevertheless, one can
write a generic transitive closure
function by using a local recursive binding:
</p><pre class="verbatim">let tr(r) = let rec t = r | (t;t) in t
</pre><p>Again, notice that the instruction <code>let tr (r) = r+</code> is equivalent.</p><p>Thanks to pattern matching constructs,
recursive functions are useful to compute over sets (and tags).
For instance here is the definition of a function <span class="c004">power</span> that compute
power sets:
</p><pre class="verbatim">let rec power S = match S with
|| {} -&gt; { {} }
|| e ++ S -&gt;
    let rec add_e RR = match RR with
    || {} -&gt; { }
    || R + RR -&gt; R ++ (e ++ R) ++ add_e RR
    end in
    add_e (power S)
end
</pre><h4 class="subsubsection" id="sec:check">Checks</h4>
<p>
The construct
</p><div class="center"><a class="syntax" href="#check"><span class="c011">check</span></a> &#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a></div><p>
evaluates <span class="c011">expr</span> and applies the check <span class="c011">check</span>.
There are six checks: the three basic acyclicity (keyword&#XA0;<span class="c005">acyclic</span>),
irreflexivity (keyword&#XA0;<span class="c005">irreflexive</span>)
and emptyness (keyword&#XA0;<span class="c005">empty</span>); and their
negations.
If the check succeeds, execution goes on. Otherwise, execution stops.</p><p><a id="name:check:def"></a>The performance of a
check can optionally be named by appending
<span class="c005">as</span> <a class="syntax" href="#id"><span class="c011">id</span></a> after it.
The feature permits not to perform some checks at user&#X2019;s will,
thanks to the <a href="#skipchecks"><span class="c004">-skipchecks&#XA0;</span><span class="c011">id</span></a>
command line&#XA0;option.</p><p>A check can also be flagged, by prefixing it with the <span class="c005">flag</span>
keyword. Flagged checks must be named with the <span class="c005">as</span> construct.
Failed flagged checks do <em>not</em> stop execution.
Instead successful flagged checks are recorded under their name,
for <span class="c007">herd7</span> machinery to handle flagged executions later.
Flagged checks are useful for models that define conditions
over executions that impact the semantics of the whole program.
This is typically the case of data races.
Let us assume that some relation <code>race</code> has been defined,
such that an non-empty <code>race</code> relation in some execution
would make the whole program undefined. We would then write:
</p><pre class="verbatim">flag ~empty race as undefined
</pre><p>Then, <span class="c007">herd7</span> will indicate in its output that some
execution have been flagged as <code>undefined</code>.</p><h4 class="subsubsection" id="sec94">Procedure definition and call</h4>
<p>
Procedures are similar to functions except that they have no results:
the body of a procedure is a list of instructions
and the procedure will be called for the effect of executing
those instructions. Intended usage of procedures is to define checks
that are executed later. However, the body of a procedure may
consist in any kind of instructions.
Notice that procedure calls can be named with the <span class="c005">as</span> keyword.
The intention is to control the performance of procedure calls
from the command line, exactly as for checks (see
<a href="#name%3Acheck%3Adef">above</a>).</p><p>As an example of procedure,
one may define the following <code>uniproc</code> procedure with
no arguments:
</p><pre class="verbatim">procedure uniproc() =
  let com = fr | rf | co in
  acyclic com | po
end
</pre><p>Then one can perform the acyclicity check (see
<a href="#sec%3Acheck">previous section</a>) by executing the instruction:
</p><pre class="verbatim">call uniproc()
</pre><p>As a result the execution will stop if the acyclicity check fails,
or continue otherwise.</p><p>Procedures are lexically scoped as functions are.
Additionally, the bindings performed during the execution of a procedure call
are discarded when the procedure returns, all other effects performed
(namely flags and shows) are retained.</p><h4 class="subsubsection" id="sec95">Show (and unshow) directives</h4>
<p>
<a id="show:def"></a>The constructs:
</p><div class="center">
<span class="c005">show</span> <a class="syntax" href="#id"><span class="c011">id</span></a> &#XA0;{ <span class="c005">,</span> <a class="syntax" href="#id"><span class="c011">id</span></a> }&#XA0;&#XA0;and&#XA0;&#XA0;<span class="c005">unshow</span> <a class="syntax" href="#id"><span class="c011">id</span></a> &#XA0;{ <span class="c005">,</span> <a class="syntax" href="#id"><span class="c011">id</span></a> }
</div><p>
take (non-empty, comma separated) lists of identifiers as arguments.
The <span class="c005">show</span> construct adds the present values of identifiers for being
shown in pictures.
The <span class="c005">unshow</span> construct removes the identifiers from shown relations.</p><p>The more sophisticated construct
</p><div class="center"><span class="c005">show</span> <a class="syntax" href="#expr"><span class="c011">expr</span></a> <span class="c005">as</span> &#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a></div><p>
evaluates <span class="c011">expr</span> to a relation, which will be shown in pictures with
label&#XA0;<span class="c011">id</span>.
Hence <span class="c005">show</span> <span class="c011">id</span> can be viewed as a shorthand
for <span class="c005">show</span> <span style="color:maroon"><span class="c010">id</span> <span class="c005">as</span> <span class="c010">id</span></span></p><h4 class="subsubsection" id="sec96">Iteration over sets</h4>
<p>
The <span class="c005">forall</span> iteration construct 
permits the iteration of checks (in fact of any kind of instructions)
over a set. Syntax is:
</p><div class="center">
<span class="c005">forall</span> &#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a> <span class="c005">in</span> &#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a> <span class="c003"><span class="c004">do</span> <span class="c011">instructions</span> <span class="c004">end</span></span>
</div><p>
The expression <span class="c011">expr</span> must evaluate to a set&#XA0;<span class="c010">S</span>.
Then, the list of instructions <span class="c011">instructions</span> is executed
for all bindings of the name&#XA0;<span class="c011">id</span> to some element of&#XA0;<span class="c010">S</span>.
In practice, as failed checks stop execution, this amounts
to check the conjunction of the checks performed by <span class="c011">instructions</span>
for all the elements of&#XA0;<span class="c010">S</span>.
Similarly to procedure calls,
the bindings performed during the execution of an iteration
are discarded at iteration ends, all other effects performed are
retained.</p><h4 class="subsubsection" id="sec97">Candidate execution extension</h4>
<p>
This construct permits the extension of the current candidate
execution by one binding.
Syntax is <span class="c005">with</span> <a class="syntax" href="#id"><span class="c011">id</span></a> <span class="c005">from</span> &#XA0;<a class="syntax" href="#expr"><span class="c011">expr</span></a>.
The expression <span class="c011">expr</span> is evaluated to a set&#XA0;<span class="c010">S</span>.
Then the remainder of the model is executed for each choice
of element&#XA0;<span class="c010">e</span> in&#XA0;<span class="c010">S</span> in a context extended by a binding
of the name&#XA0;<span class="c011">id</span> to&#XA0;<span class="c010">e</span>.
An example of the construct usage is described in Sec.&#XA0;<a href="#intro%3Awith">12.3</a>.</p><h4 class="subsubsection" id="sec98">Model inclusion</h4>
<p>
The construct <span class="c003"><span class="c004">include</span> <span class="c004">"</span><span class="c011">filename</span><span class="c004">"</span></span> is interpreted as
the inclusion of the model contained in the file whose name is given as
an argument to the <span class="c005">include</span> instruction.
In practice the list of intructions defined by the included model file
are executed.
The string argument is delimited by double quotes &#X201C;<code>"</code>&#X201D;,
which, of course, are not part of the filename.
Files are searched according to <span class="c007">herd7</span> rules &#X2014; see Sec.&#XA0;<a href="#herd%3Asearchpath">15.4</a>.
</p><h3 class="subsection" id="sec99">Bell extensions</h3>
<p>Users can attain more genericity in their models by defining a <span class="c004">bell</span> file,
as an addendum, or rather preamble, to a <span class="c004">cat</span> file.</p><h4 class="subsubsection" id="sec:enum">Enumerations</h4>
<p>
The <span class="c005">enum</span> construct defines a set of enumerated values or tags. Syntax is
</p><div class="center">
<span class="c005">enum</span> <a class="syntax" href="#id"><span class="c011">id</span></a> <span class="c005">=</span> &#XA0;<a class="syntax" href="#tag"><span class="c011">tag</span></a><sub>1</sub> <span class="c005">||</span> &#X22EF; <span class="c005">||</span> &#XA0;<a class="syntax" href="#tag"><span class="c011">tag</span></a><sub><span class="c010">n</span></sub>
</div><p>
The construct has two main effects.
It first defines the tags <span class="c011">tag</span><sub>1</sub>,&#X2026;,<span class="c011">tag</span><sub><span class="c010">n</span></sub>.
Notice that tags do not exist before being defined, that is
evaluating the expression <span class="c011">tag</span> is an error without a prior
<span class="c005">enum</span> that defines the tag&#XA0;<span class="c011">tag</span>. Tags are typed in the sense
that they belong to the tag type <span class="c011">id</span> and that tags from
different types cannot be members of the same set.
The second effect of the construct is to define a set of tags&#XA0;<span class="c011">id</span>
as the set of all tags listed in the construct.
That is, the <span class="c005">enum</span> construct performs the binding of&#XA0;<span class="c011">id</span>
to <span class="c005">{</span> <span class="c011">tag</span><sub>1</sub>,&#X2026;,<span class="c011">tag</span><sub><span class="c010">n</span></sub><span class="c005">}</span>.</p><p><em>Scopes</em> are a special case of enumeration: the construct <span class="c004">enum
scopes</span> must be used to define hierarchical models such as Nvidia GPUs.
</p><p>An <span class="c004">enum scopes</span> declaration must be paired with two functions <span class="c004">narrower</span> and <span class="c004">wider</span> that implement the hierarchy amongst scopes. For example:</p><pre class="verbatim">enum scopes = 'discography || 'I || 'II || 'III || 'IV

let narrower(t) = match t with
  || 'discography -&gt; {'I, 'II, 'III, 'IV} 
end

let wider(t) = match t with
  || 'I -&gt; 'discography
  || 'II -&gt; 'discography
  || 'III -&gt; 'discography
  || 'IV -&gt; 'discography
end
</pre><p>Here we define five scopes, where the first one, <span class="c004">discography</span>, is wider
than all the other ones.</p><h4 class="subsubsection" id="sec101">Instructions</h4>
<p>
The predefined sets of events <span class="c007">W</span>, <span class="c007">R</span>, <span class="c007">RMW</span>,
<span class="c007">F</span>, and <span class="c007">B</span> can be <em>annotated</em> with user-defined tags
(see Sec.&#XA0;<a href="#sec%3Aenum">14.4</a>).</p><p>The constructs:</p><div class="center">
<span class="c005">instructions</span>&#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a>&#XA0;<span class="c011">[taglist]</span> 
</div><p>take the identifier of a pre-defined set and a possibly empty, square bracketed
list of tags. </p><p>The primitive <span class="c004">tag2instrs</span> yields, given a tag <span class="c004">&#X2019;t</span>, the set of
instructions bearing the annotation <span class="c004">t</span> that was previously declared in an
enumeration type.
</p><p>The primitive <span class="c004">tag2scope</span> yields, given a tag <span class="c004">&#X2019;t</span>, the relation
between instructions TODO </p>
<h3 class="subsection" id="language:model">14.5&#XA0;&#XA0;Models</h3>
<table class="display dcenter"><tr class="c020"><td class="dcell"><table class="c001 cellpading0"><tr><td class="c019">
<a class="syntax" id="model"><span class="c011">model</span></a>&#XA0;</td><td class="c015">::=</td><td class="c017">&#XA0;<a class="syntax" href="#model-comment"><span class="c011">model-comment</span></a>&#XA0;&#XA0;&#XA0;<a class="syntax" href="#instruction"><span class="c011">instruction</span></a>&#XA0;}
&#XA0;</td></tr>
<tr><td class="c019">&nbsp;</td></tr>
<tr><td class="c019">
<a class="syntax" id="model-comment"><span class="c011">model-comment</span></a>&#XA0;</td><td class="c015">::=</td><td class="c017">&#XA0;<a class="syntax" href="#id"><span class="c011">id</span></a>&#XA0;&#X2223;&#XA0;&#XA0;&#XA0;<span class="c011">string</span>
</td></tr>
</table></td></tr>
</table><p>
A model is a list of instruction preceded by a small comment,
which can be either a name that follows <span class="c007">herd7</span> conventions for identifiers,
or a string enclosed in double quotes&#XA0;&#X201C;<code>"</code>&#X201D;.</p><p>Models operate on candidate executions
(see Sec.&#XA0;<a href="#sec%3Apredef">14.2</a>),
instructions are executed in sequence,
until one instruction stops, or until the end of the instruction list.
In that latter case, the model accepts the execution.
The accepted execution is then passed over to the rest of <span class="c007">herd7</span>
engine, in order to collect final states of locations
and to display pictures.</p>
<h3 class="subsection" id="sec:primitive">14.6&#XA0;&#XA0;Primitives</h3>
<p>TODO:</p>
<h3 class="subsection" id="sec:library">14.7&#XA0;&#XA0;Library</h3>
<h4 class="subsubsection" id="sec105">Standard library</h4>
<p>
The standard library is a <span class="c004">cat</span> file&#XA0;<span class="c004">stdlib.cat</span>
which all models include by default.
It defines a a few convenient relations that are thus
available to all models.
</p><div class="showcenter">
<table class="c001 cellpading0"><tr><td class="c015" colspan=2>identifier</td><td class="c015" colspan=2>name</td><td class="c015">description
</td></tr>
<tr><td class="hbar" colspan=5></td></tr>
<tr><td class="c025"><span class="c004">po-loc</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023"><span class="c004">po</span> restricted to the same address</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">events are in <span class="c004">po</span> and touch the same address, namely <span class="c004">po</span> &#X2229; <span class="c004">loc</span></td></tr>
<tr><td class="c025"><span class="c004">rfe</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">external read-from</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">read-from by different threads, namely <span class="c004">rf</span> &#X2229; <span class="c004">ext</span></td></tr>
<tr><td class="c025"><span class="c004">rfi</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">internal read-from</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">read-from by the same thread, namely <span class="c004">rf</span> &#X2229; <span class="c004">int</span></td></tr>
</table></div><h4 class="subsubsection" id="sec106">Coherence orders</h4>
<p>
For most models, a complete list of communication relations would
also include <span class="c004">co</span> and&#XA0;<span class="c004">fr</span>.
Those can be defined by including the file <span class="c004">cos.cat</span>
(see Sec.&#XA0;<a href="#sec%3Acos">12.4</a>).
</p><div class="showcenter">
<table class="c001 cellpading0"><tr><td class="c015" colspan=2>identifier</td><td class="c015" colspan=2>name</td><td class="c015">description
</td></tr>
<tr><td class="hbar" colspan=5></td></tr>
<tr><td class="c025"><span class="c004">co</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">coherence</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">total order over writes to the same address </td></tr>
<tr><td class="c025"><span class="c004">fr</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">from-read</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">links a read <span class="c010">r</span> to a write <span class="c010">w</span>&#X2032; <span class="c004">co</span>-after the write <span class="c010">w</span> from which <span class="c010">r</span> takes its value </td></tr>
<tr><td class="c025"><span class="c004">coi</span>, <span class="c004">fri</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">internal communications</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">communication between events of the same thread</td></tr>
<tr><td class="c025"><span class="c004">coe</span>, <span class="c004">fre</span></td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">external communications</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">communication between events of different threads
</td></tr>
</table></div><p>
Notice that the internal and external sub-relations of <span class="c004">co</span> and&#XA0;<span class="c004">fr</span>
are also defined.
</p><h4 class="subsubsection" id="sec107">Fences</h4>
<p>
Fence relations denote the presence of a specific
fence (or barrier) in-between two events.
Those can be defined by includinc architecture specific files.
</p><div class="showcenter">
<table class="c001 cellpading0"><tr><td class="c015" colspan=2>file</td><td class="c015">relations
</td></tr>
<tr><td class="hbar" colspan=3></td></tr>
<tr><td class="c025">x86fences.cat</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023"><span class="c004">mfence</span>, <span class="c004">sfence</span>, <span class="c004">lfence</span></td></tr>
<tr><td class="c025">ppcfences.cat</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023"><span class="c004">sync</span>, <span class="c004">lwsync</span>, <span class="c004">eieio</span>, <span class="c004">isync</span>, <span class="c004">ctrlisync</span></td></tr>
<tr><td class="c025">armfences.cat</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023"><span class="c004">dsb</span>, <span class="c004">dmb</span>, <span class="c004">dsb.st</span>, <span class="c004">dmb.st</span>, <span class="c004">isb</span>, <span class="c004">ctrlisb</span></td></tr>
<tr><td class="c025">mipsfences.cat</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023"><span class="c004">sync</span></td></tr>
<tr><td class="c025">aarch64fences.cat</td><td class="c015">&#XA0;&#XA0;&#XA0;&#XA0;</td><td class="c023">&#X2026;</td></tr>
</table></div><p>
In other words, models for, say, ARM machines should include the following
instruction:
</p><pre class="verbatim">include "armfences.cat"
</pre><p>Notice that for the Power (PPC) (resp. ARM) architecture,
an additional relation <span class="c004">ctrlisync</span> (res. <span class="c004">ctrlisb</span>) is defined.
The relation <span class="c004">ctrlisync</span> reads control +<span class="c004">isync</span>.
It means that the branch to the instruction that generates the
second event additionnaly contains
a <span class="c004">isync</span> fence preceeding that instruction.
For reference, here is a possible definition of <span class="c004">ctrlisync</span>:
</p><pre class="verbatim">let ctrlisync  = ctrl &amp; (_ * ISYNC); po
</pre><p>One may define all fence relations by including the file
<span class="c004">fences.cat</span>. As a result, fence relations that are
relevant to the architecture of the test being simulated are properly defined,
while irrelevant fence relations are the empty relation.
This feature proves convenient for writing generic models that apply
to several concrete architectures.
</p>
<h2 class="section" id="sec108">15&#XA0;&#XA0;Usage of <span class="c007">herd7</span></h2>
<h3 class="subsection" id="sec109">15.1&#XA0;&#XA0;Arguments</h3>
<p>
The command <span class="c007">herd7</span> handles its arguments like <span class="c007">litmus7</span>.
That is, <span class="c007">herd7</span> interprets its argument as file names.
Those files are either a single litmus test
when having extension <span class="c004">.litmus</span>, or a list of file names
when prefixed by <span class="c004">@</span>.</p>
<h3 class="subsection" id="sec110">15.2&#XA0;&#XA0;Options</h3>
<p>
There are many command line options.
We describe the more useful ones:</p><h4 class="paragraph" id="sec111">General behaviour</h4>
<dl class="description"><dt class="dt-description">
<span class="c006">-version</span></dt><dd class="dd-description"> Show version number and exit.
</dd><dt class="dt-description"><span class="c006">-libdir</span></dt><dd class="dd-description"> Show installation directory and exit.
</dd><dt class="dt-description"><span class="c006">-v</span></dt><dd class="dd-description"> Be verbose, can be repeated to increase verbosity.
</dd><dt class="dt-description"><span class="c006">-q</span></dt><dd class="dd-description"> Be quiet, suppress any diagnostic message.
</dd><dt class="dt-description"><span class="c006">-conf &lt;name&gt;</span></dt><dd class="dd-description"> Read configuration file&#XA0;<span class="c004">name</span>.
<a href="#herd%3Aconfigfile">Configuration files</a> have a very simple syntax:
a line &#X201C;<span class="c010">opt<span class="c004"> </span>arg</span>&#X201D; has the same effect as
the command-line option &#X201C;<span class="c004">-</span><span class="c010">opt arg</span>&#X201D;.
</dd><dt class="dt-description"><span class="c006">-o &lt;dest&gt;</span></dt><dd class="dd-description"> Output files into directory <span class="c004">&lt;dest&gt;</span>.
Notice that <span class="c004">&lt;dest&gt;</span> must exist.
At the moment <span class="c007">herd7</span> may output one <span class="c004">.dot</span> file per processed test:
the file for test <span class="c010">base</span><span class="c004">.litmus</span>
is named <span class="c010">base</span><span class="c004">.dot</span>.
By default <span class="c007">herd7</span> does not generate <span class="c004">.dot</span> files.
</dd><dt class="dt-description"><span class="c006">-suffix &lt;suf&gt;</span></dt><dd class="dd-description"> Change the name of <span class="c004">.dot</span> files
into <span class="c010">basesuff</span><span class="c004">.dot</span>. Useful when several <span class="c004">.dot</span> files derive from the same test. Default is the empty string (no suffix).
</dd><dt class="dt-description"><a id="opt:gv"><span class="c006">-gv</span></a></dt><dd class="dd-description"> Fork the <a href="http://www.gnu.org/software/gv/"><span class="c007">gv</span> Postscript viewer</a> to display execution diagrams.
</dd><dt class="dt-description"><a id="opt:evince"><span class="c006">-evince</span></a></dt><dd class="dd-description"> Fork the evince document viewer to display execution diagrams. This option provides an alternative to the
<span class="c004">gv</span> viewer.
</dd><dt class="dt-description"><span class="c006">-dumpes &lt;bool&gt;</span></dt><dd class="dd-description">
Dump genererated event structures and exit. Default is <span class="c004">false</span>.
Event structures will be dumped in a <span class="c004">.dot</span> file whose
name is determined as usual &#X2014; See options <span class="c004">-o</span> and <span class="c004">-suffix</span> above.
Optionally the event structures can be displayed with the <span class="c004">-gv</span> option.
</dd><dt class="dt-description"><span class="c006">-unroll &lt;int&gt;</span></dt><dd class="dd-description"> The setting <span class="c004">-unroll </span><span class="c010">n</span> performs backwards
jumps <span class="c010">n</span> times. This is a workaround for one of <span class="c007">herd7</span> main limitation:
<span class="c007">herd7</span> does not really handle loops. Default is&#XA0;<span class="c004">2</span>.
</dd><dt class="dt-description"><span class="c006">-hexa &lt;bool&gt;</span></dt><dd class="dd-description"> Print numbers in hexadecimal. Default is <span class="c004">false</span>
(numbers are printed in decimal).
</dd></dl>
<h4 class="paragraph" id="sec112">Engine control</h4>
<p>
The main purpose of <span class="c007">herd7</span> is to run tests on top of memory models.
For a given test, <span class="c007">herd7</span> performs a three stage process:
</p><ol class="enumerate" type=1><li class="li-enumerate">
Generate candidate executions.
</li><li class="li-enumerate">For each candidate execution, run the model.
The model may reject or accept the execution.
</li><li class="li-enumerate">For each candidate execution that the model accepts,
record observed locations and, if so instructed,
a diagram of the execution.
</li></ol><p>
We now describe options that control those three stages.</p><dl class="description"><dt class="dt-description">
<span class="c006">-model (cav12|minimal|uniproc|&lt;filename&gt;.cat)</span></dt><dd class="dd-description">
Select model, this option accept one tag or one file name
with extension&#XA0;<span class="c004">.cat</span>.
Tags instruct <span class="c007">herd7</span> to select an internal model,
while file names are read for a model definition.
Documented model tags are:
<ul class="itemize"><li class="li-itemize">
<span class="c004">cav12</span>, the model of&#XA0;[<a href="diy006.html#mms12">4</a>] (Power);
</li><li class="li-itemize"><span class="c004">minimal</span>, the minimal model that allows all executions;
</li><li class="li-itemize"><span class="c004">uniproc</span>, the uniproc model that checks single-thread correctness.
</li></ul><p>In fact, <span class="c007">herd7</span> accepts potentially infinitely many models,
as models can given in text files in an adhoc language described in
Sec.&#XA0;<a href="#herd%3Alanguage">14</a>.
The <span class="c007">herd7</span> distribution includes several such models:
<a href="herd.cat"><span class="c004">herd.cat</span></a>, <a href="minimal.cat"><span class="c004">minimal.cat</span></a>, <a href="uniproc.cat"><span class="c004">uniproc.cat</span></a>
and <a href="x86tso.cat"><span class="c004">x86tso.cat</span></a> are
text file versions of the homonymous internal models, but may
produce pictures that show different relations.
Model files are searched according to the same
<a href="#herd%3Asearchpath">rules</a>
as configuration files.
Some architectures have a default model:
<span class="c004">arm.cat</span> model for ARM, <span class="c004">ppc.cat</span> model for PPC,
<span class="c004">x86tso.cat</span> for X86, and <span class="c004">mips-pso.cat</span> for MIPS.</p></dd><dt class="dt-description"><span class="c006">-through (all|invalid|none)</span></dt><dd class="dd-description">
Let additional executions reach the final stage of <span class="c007">herd7</span> engine.
This option permits users to generate pictures of forbidden executions, which
are otherwise rejected at an early stage of <span class="c007">herd7</span> engine &#X2014; see Sec.&#XA0;<a href="#show%3Aforbidden">13.2</a>.
Namely, the default&#XA0;&#X201C;<span class="c004">none</span>&#X201D; let only valid (according to the
active model) executions through.
The behaviour of this option differs between internal and text file models:
<ul class="itemize"><li class="li-itemize">
For internal models:
the tag&#XA0;<span class="c004">all</span> let all executions go through;
while the tag&#XA0;<span class="c004">invalid</span> will reject executions that violate uniproc,
while letting other forbidden execution go through.
</li><li class="li-itemize">Text file models: the tags <span class="c004">all</span> and&#XA0;<span class="c004">invalid</span> let all
executions go through. For such models, a more precise control over
executions that reach <span class="c007">herd7</span> final phase can be achieved
with the option&#XA0;<span class="c004">-skipcheck</span> &#X2014; see next option.
</li></ul>
Default is&#XA0;<span class="c004">none</span>.</dd><dt class="dt-description"><span class="c006">-skipchecks &lt;<span class="c010">name</span></span><sub>1</sub><span class="c006">,&#X2026;,<span class="c010">name</span></span><sub><span class="c010">n</span></sub><span class="c006">&gt;</span></dt><dd class="dd-description">
<a id="skipchecks">This option</a>
applies to text file models. It instructs <span class="c007">herd7</span> to ignore
the outcomes of the given checks. For the option to operate, checks must
be named in the model file with the <span class="c004">as </span><span class="c010">name</span> construct &#X2013;
see Sec.&#XA0;<a href="#name%3Acheck%3Adef">14.4</a>.
Notice that the arguments to <span class="c004">-skipcheck</span> options cumulate.
That is, &#X201C;<span class="c004">-skipcheck </span><span class="c010">name</span><sub>1</sub> <span class="c004">-skipcheck </span><span class="c010">name</span><sub>2</sub>&#X201D; acts like &#X201C;<span class="c004">-skipcheck </span><span class="c010">name</span><sub>1</sub><span class="c004">,</span><span class="c010">name</span><sub>2</sub>&#X201D;. </dd><dt class="dt-description"><span class="c006">-strictskip &lt;bool&gt;</span></dt><dd class="dd-description"> Setting this option (<span class="c004">-strictskip true</span>),
will change the behaviour of the previous option <span class="c004">-skipcheck</span>:
it will let executions go through when the skipped checks yield
false and the unskipped checks yield true. This option comes handy
when one want to observe the executions that fail one (or several) checks
while passing others. Default is <span class="c004">false</span>.</dd><dt class="dt-description"><span class="c006">-optace &lt;bool&gt;</span></dt><dd class="dd-description"> Optimise the axiomatic candidate execution stage.
When enabled by <span class="c004">-optace true</span>, <span class="c007">herd7</span> does not generate candidate
executions that fail the uniproc test. The default is &#X201C;<span class="c004">true</span>&#X201D;
for internal models (except the minimal model), and &#X201C;<span class="c004">false</span>&#X201D; for
text file models. Notice that <span class="c004">-model uniproc.cat</span>
and <span class="c004">-model minimal.cat -optace true</span> should yield identical results,
the second being faster.
Setting <span class="c004">-optace true</span> can lower the execution time significantly,
but one should pay attention not to design models that forget the uniproc
condition.</dd><dt class="dt-description"><a id="opt:show"><span class="c006">-show</span></a><span class="c006"> (prop|neg|all|cond|wit|none)</span></dt><dd class="dd-description">
Select execution diagrams for picture display and generation.
Execution diagrams are shown according to
the final condition of test. The final condition is a quantified boolean
proposition <code>exists </code><span class="c010">p</span>, <code>~exists </code><span class="c010">p</span>, or <code>forall </code><span class="c010">p</span>.
The semantics of recognised tags is as follows:
<ul class="itemize"><li class="li-itemize">
<span class="c004">prop</span> Picture executions for which <span class="c010">p</span> is true.
</li><li class="li-itemize"><span class="c004">neg</span> Picture executions for which <span class="c010">p</span> is false.
</li><li class="li-itemize"><span class="c004">all</span> Picture all executions.
</li><li class="li-itemize"><span class="c004">cond</span> Picture executions that validate the condition,
<em>i.e.</em> <span class="c010">p</span> is true for <code>exists</code> and <code>forall</code>, and false
for <code>~exists</code>.
</li><li class="li-itemize"><span class="c004">wit</span> Picture &#X201C;<em>interesting</em>&#X201D; executions,
<em>i.e.</em> <span class="c010">p</span> is true for <code>exists</code> and <code>~exists</code>,
and false for <code>forall</code>.
</li><li class="li-itemize"><span class="c004">none</span> Picture no execution.
</li></ul>
Default is <span class="c004">none</span>.</dd><dt class="dt-description"><a id="opt:initwrites"><span class="c006">-initwrites</span></a><span class="c006"> &lt;bool&gt;</span></dt><dd class="dd-description">
Represent init writes as plain write events, default is <span class="c004">false</span> except
for specifically tagged generic models &#X2014; see &#X201C;Model options&#X201D;
in Sec.&#XA0;<a href="#language%3Amodel">14.5</a>.</dd></dl><h4 class="paragraph" id="sec113">Discard some observations</h4>
<p>
Those options intentionally omit some of the final states that <span class="c007">herd7</span> would
normally generate.</p><dl class="description"><dt class="dt-description">
<span class="c006">-speedcheck (false|true|fast)</span></dt><dd class="dd-description"> 
<a id="speedcheck:opt">When</a> enabled by <span class="c004">-speedcheck true</span>
or <span class="c004">-speedcheck fast</span>, attempt to settle the test condition.
That is, <span class="c007">herd7</span> will
generate a subset of executions (those named &#X201C;<em>interesting</em>&#X201D; above)
in place of all executions.
With setting <span class="c004">-speedcheck fast</span>,
<span class="c007">herd7</span> will additionally stop as soon as a condition <code>exists </code><span class="c010">p</span> is validated, and as soon as a condition <code>~exists </code><span class="c010">p</span> or
<code>forall </code><span class="c010">p</span> is invalidated. Default is <span class="c004">false</span>.</dd><dt class="dt-description"><span class="c006">-nshow &lt;int&gt;</span></dt><dd class="dd-description">
Stop once <code>&lt;int&gt;</code> pictures have been collected. Default is to
collect all (specified, see option <a href="#opt%3Ashow"><span class="c004">-show</span></a>) pictures.
</dd></dl><h4 class="paragraph" id="sec114">Control <span class="c004">dot</span> pictures</h4>
<p>
These options control the content of DOT images.</p><p>We first describe options that act at the general level.
</p><dl class="description"><dt class="dt-description">
<span class="c006">-graph (cluster|free|columns)</span></dt><dd class="dd-description"> Select main mode for graphs.
See Sec.&#XA0;<a href="#mode%3Aexample">13.1</a>. The default is <span class="c004">cluster</span>.
</dd><dt class="dt-description"><span class="c006">-dotmode (plain|fig)</span></dt><dd class="dd-description"> The setting <span class="c004">-dotmode fig</span>
produces output that includes the proper escape
sequence for translating <span class="c004">.dot</span> files
to <span class="c004">.fig</span> files (<em>e.g.</em> with <span class="c004">dot -Tfig&#X2026;</span>).
Default is <span class="c004">plain</span>.
</dd><dt class="dt-description"><span class="c006">-dotcom (dot|neato|circo)</span></dt><dd class="dd-description"> Select the command that formats
graphs displayed by the <a href="#opt%3Agv"><span class="c004">-gv</span></a> option.
The default is <span class="c004">dot</span> for the <span class="c004">cluster</span> and&#XA0;<span class="c004">free</span> graph modes,
and <span class="c004">neato</span> for the <span class="c004">columns</span> graph mode.</dd><dt class="dt-description"><span class="c006">-showevents (all|mem|noregs)</span></dt><dd class="dd-description"> Control which events are
pictured:
<ul class="itemize"><li class="li-itemize">
<span class="c004">all</span> Picture all events.
</li><li class="li-itemize"><span class="c004">mem</span> Picture memory events.
</li><li class="li-itemize"><span class="c004">noregs</span> Picture all events except register events,
<em>i.e.</em> memory, fences and branch events.
</li></ul>
Default is <span class="c004">noregs</span>.</dd><dt class="dt-description"><span class="c006">-showinitwrites &lt;bool&gt;</span></dt><dd class="dd-description"> Show initial write events
(when existing, see option&#XA0;<a href="#opt%3Ainitwrites">-initwrites</a>)
in pictures. Default is <span class="c004">true</span>.</dd><dt class="dt-description"><span class="c006">-mono &lt;bool&gt;</span></dt><dd class="dd-description"> The setting <span class="c004">-mono true</span> commands monochrome
pictures. This option acts upon default color selection. Thus, it
has no effect on colors given explicitely with the
<a href="#opt%3Aedgeattr"><span class="c004">-edgeattr</span></a> option.</dd><dt class="dt-description"><span class="c006">-scale &lt;float&gt;</span></dt><dd class="dd-description">
Global scale factor for graphs in <span class="c004">columns</span> mode.
Default is <span class="c004">1.0</span>.
</dd><dt class="dt-description"><span class="c006">-xscale &lt;float&gt;</span></dt><dd class="dd-description">
Global scale factor for graphs in <span class="c004">columns</span> mode, x direction.
Default is <span class="c004">1.0</span>.
</dd><dt class="dt-description"><span class="c006">-yscale &lt;float&gt;</span></dt><dd class="dd-description">
Global scale factor for graphs in <span class="c004">columns</span> mode, y direction.
Default is <span class="c004">1.0</span>.
</dd><dt class="dt-description"><span class="c006">-showthread &lt;bool&gt;</span></dt><dd class="dd-description"> Show thread numbers in figures.
In <span class="c004">cluster</span> mode where the events of a thread are clustered,
thread cluster have a label.
In <span class="c004">free</span> mode <span class="c007">po</span> edges are suffixed by a thread number.
In <span class="c004">columns</span> mode, columhs have a header node that shows
the thread number. Default is&#XA0;<span class="c004">true</span>.
</dd><dt class="dt-description"><span class="c006">-texmacros &lt;bool&gt;</span></dt><dd class="dd-description"> Use latex commands in some text of pictures.
If activated (<span class="c004">-showthread true</span>), thread numbers are shown as
<code>\myth{</code><span class="c010">n</span><code>}</code>. Assembler instructions are locations in nodes
are argument to an <code>\asm</code> command. It user responsability to define
those commands in their L<sup>A</sup>T<sub>E</sub>X documents that include the pictures.
Possible definitions are <code>\newcommand{\myth}[1]{Thread~#1}</code>
and <code>\newcommand{\asm}[1]{\texttt{#1}}</code>.
Default is&#XA0;<span class="c004">false</span>.
</dd></dl><p>A few options control picture legends.
</p><dl class="description"><dt class="dt-description">
<span class="c006">-showlegend &lt;bool&gt;</span></dt><dd class="dd-description">
Add a legend to pictures. By default legends show the test name and
a comment from the executed model.
This comment is the first item
of model syntax &#X2014; see Sec&#XA0;<a href="#language%3Amodel">14.5</a>.
Default is&#XA0;<span class="c004">true</span>.
</dd><dt class="dt-description"><span class="c006">-showkind &lt;bool&gt;</span></dt><dd class="dd-description">
Show test kind in legend.
The kind derive from the quantifier of test final condition,
kind <span class="c004">Allow</span> being <code>exists</code>,
kind <span class="c004">Forbid</span> being <code>~exists</code>,
and kind <span class="c004">Require</span> being <code>forall</code>.
Default is&#XA0;<span class="c004">false</span>.
</dd><dt class="dt-description"><span class="c006">-shortlegend &lt;bool&gt;</span></dt><dd class="dd-description">
Limit legend to test name. Default is&#XA0;<span class="c004">false</span>.
</dd></dl><p>A few options control what is shown in nodes
and on their sizes, <em>i.e.</em>
on how events are pictured.
</p><dl class="description"><dt class="dt-description">
<span class="c006">-squished &lt;bool&gt;</span></dt><dd class="dd-description"> The setting <span class="c004">-squished true</span> drastically
limits the information displayed in graph nodes. This is usually what
is wanted in modes <span class="c004">free</span> and&#XA0;<span class="c004">columns</span>. Default is&#XA0;<span class="c004">false</span>.
</dd><dt class="dt-description"><span class="c006">-fixedsize &lt;bool&gt;</span></dt><dd class="dd-description"> This setting is meaningfull in
<span class="c004">columns</span> graph mode and for squished nodes. When set by
<span class="c004">-fixedsize true</span> it forces node width to be 65% of the space
between columns. This may sometime yield a nice edge routing. Default is&#XA0;<span class="c004">false</span>
</dd><dt class="dt-description"><span class="c006">-extrachars &lt;float&gt;</span></dt><dd class="dd-description"> This setting is meaningful in
<span class="c004">columns</span> graph mode and for squished nodes.
When the size of nodes is not fixed (<em>i.e.</em> <span class="c004">-fixedsize false</span> and default), <span class="c007">herd7</span> computes the width of nodes by counting caracters in node
labels and scaling the result by the font size.
The setting <span class="c004">-extrachars&#XA0;</span><span class="c010">v</span> commands adding the value <span class="c010">v</span> before scaling.
Negative values are of course accepted. Default is <span class="c004">0.0</span>.
</dd><dt class="dt-description"><span class="c006">-showobserved &lt;bool&gt;</span></dt><dd class="dd-description"> Highlight observed memory read events with
stars &#X201C;<span class="c004">*</span>&#X201D;. A memory read is observed when the value it reads
is stored in a register that appears in final states.
Default is&#XA0;<span class="c004">false</span>.
</dd><dt class="dt-description"><span class="c006">-brackets &lt;bool&gt;</span></dt><dd class="dd-description"> Show brackets around locations. Default
is&#XA0;<span class="c004">false</span>.
</dd></dl><p>Then we list options that offer some control on which edges are shown.
We recall that the main controls over the shown and unshown edges are
the <code>show</code> and <code>unshow</code> directives in model definitions &#X2014;
see Sec.&#XA0;<a href="#show%3Adef">14.4</a>.
However, some edges can be controled only with options (or configuration
files) and the <span class="c004">-unshow</span> option proves convenient.
</p><dl class="description"><dt class="dt-description">
<span class="c006">-showpo &lt;bool&gt;</span></dt><dd class="dd-description"> Show program order (<span class="c007">po</span>) edges.
Default is&#XA0;<span class="c004">true</span>.
Default is&#XA0;<span class="c004">false</span>.
</dd><dt class="dt-description"><span class="c006">-showinitrf &lt;bool&gt;</span></dt><dd class="dd-description"> Show read-from edges from initial state.
Default is&#XA0;<span class="c004">false</span>.
</dd><dt class="dt-description"><span class="c006">-showfinalrf &lt;bool&gt;</span></dt><dd class="dd-description"> Show read-from edges to the final state,
<em>i.e</em> show the last store to locations. Default is&#XA0;<span class="c004">false</span>.
<em>i.e</em> show the last store to locations. Default is&#XA0;<span class="c004">false</span>.
</dd><dt class="dt-description"><span class="c006">-showfr &lt;bool&gt;</span></dt><dd class="dd-description"> Show from-read edges. Default is&#XA0;<span class="c004">true</span>.
</dd><dt class="dt-description"><span class="c006">-doshow &lt;<span class="c010">name</span></span><sub>1</sub><span class="c006">,&#X2026;,<span class="c010">name</span></span><sub><span class="c010">n</span></sub><span class="c006">&gt;</span></dt><dd class="dd-description">
Do show edges labelled with <span class="c010">name</span><sub>1</sub>,&#X2026;,<span class="c010">name</span><sub><span class="c010">n</span></sub>.
This setting applies when names are bound in model definition.
</dd><dt class="dt-description"><span class="c006">-unshow &lt;<span class="c010">name</span></span><sub>1</sub><span class="c006">,&#X2026;,<span class="c010">name</span></span><sub><span class="c010">n</span></sub><span class="c006">&gt;</span></dt><dd class="dd-description">
Do not show edges labelled with <span class="c010">name</span><sub>1</sub>,&#X2026;,<span class="c010">name</span><sub><span class="c010">n</span></sub>.
This setting applies at the very last momement and thus cancels any
<code>show</code> directive in model definition and any <span class="c004">-doshow</span> command
line&#XA0;option.
</dd></dl><p>
Other options offer some control over some of the attributes defined in
<a href="http://graphviz.org/">Graphviz software</a> documentation.
Notice that the controlled attributes are omitted from DOT files
when no setting is present.
For instance in the absence of a <span class="c004">-spline &lt;tag&gt;</span> option, <span class="c007">herd7</span>
will generate no definition for the <span class="c004">splines</span> attribute thus
resorting to DOT tools defaults.
Most of the following
options accept the <span class="c004">none</span>&#XA0;argument that restores their
default behaviour.
</p><dl class="description"><dt class="dt-description">
<span class="c006">-splines (spline|true|line|false|polyline|ortho|curved|none)</span></dt><dd class="dd-description">
Define the value of the <span class="c004">splines</span> attribute. Tags are replicated in
output files as the value of the attribute, except for <span class="c004">none</span>.
</dd><dt class="dt-description"><span class="c006">-margin &lt;float|none&gt;</span></dt><dd class="dd-description"> Specifies the <span class="c004">margin</span> attribute of graphs.
</dd><dt class="dt-description"><span class="c006">-pad &lt;float|none&gt;</span></dt><dd class="dd-description"> Specifies the <span class="c004">pad</span> attribute of graphs.
</dd><dt class="dt-description"><span class="c006">-sep &lt;string|none&gt;</span></dt><dd class="dd-description"> Specifies the <span class="c004">sep</span> attribute of graphs.
Notice that the argument is an arbitray string, so as to allow DOT general
syntax for this attribute.
</dd><dt class="dt-description"><span class="c006">-fontname &lt;string|none&gt;</span></dt><dd class="dd-description"> Specifies the graph fontname attribute.
</dd><dt class="dt-description"><span class="c006">-fontsize &lt;int|none&gt;</span></dt><dd class="dd-description"> Specifies the fontsize attribute&#XA0;<span class="c010">n</span> of all
text in the graph.
</dd><dt class="dt-description"><span class="c006">-edgefontsizedelta &lt;int&gt;</span></dt><dd class="dd-description"> option <span class="c004">-edgefontsizedelta </span><span class="c010">m</span> sets
the fontsize attributes of edges to <span class="c010">n</span>+<span class="c010">m</span>, where <span class="c010">n</span> is the argument to
the <span class="c004">-fontsize</span> option. Default is <span class="c004">0</span>. This option has no effect if
fontsize is unset.
</dd><dt class="dt-description"><span class="c006">-penwidth &lt;float|none&gt;</span></dt><dd class="dd-description"> Specifies the <span class="c004">penwidth</span> attribute of
edges.
</dd><dt class="dt-description"><span class="c006">-arrowsize &lt;float|none&gt;</span></dt><dd class="dd-description"> Specifies the <span class="c004">arrowsize</span>
attribute of edges.
</dd><dt class="dt-description"><a id="opt:edgeattr"><span class="c006">-edgeattr</span></a><span class="c006"> &lt;label,attribute,value&gt;</span></dt><dd class="dd-description">
Give value <span class="c004">value</span> to attribute <span class="c004">attribute</span> of all edges labelled
<span class="c004">label</span>. This powerful option permits alternative styles for edges.
For instance, the <span class="c007">ghb</span> edges of the diagrams of this document
are thick purple (blueviolet) arrows thanks to the settings:
<span class="c004">-edgeattr ghb,color,blueviolet</span>
<span class="c004">-edgeattr ghb,penwidth,3.0</span>
<span class="c004">-edgeattr ghb,arrowsize,1.2</span>. Notice that the settings performed
by the <span class="c004">-edgeattr</span> option override other settings.
This option has no default.
</dd></dl><h4 class="paragraph" id="sec115">Change input</h4>
<p>
Those options are the same as the ones
of&#XA0;<span class="c007">litmus7</span> &#X2014; see Sec.&#XA0;<a href="litmus.html#change%3Ainput">4</a>.</p><dl class="description"><dt class="dt-description">
<span class="c006">-names &lt;file&gt;</span></dt><dd class="dd-description"> Run <span class="c007">herd7</span> only on tests whose names are
listed in <span class="c004">&lt;file&gt;</span>.
</dd><dt class="dt-description"><span class="c006">-rename &lt;file&gt;</span></dt><dd class="dd-description"> Change test names.
</dd><dt class="dt-description"><span class="c006">-kinds &lt;file&gt;</span></dt><dd class="dd-description"> Change test kinds.
This amonts to changing the quantifier of final conditions, with
kind <span class="c004">Allow</span> being <code>exists</code>,
kind <span class="c004">Forbid</span> being <code>~exists</code>
and kind <span class="c004">Require</span> being <code>forall</code>.
</dd><dt class="dt-description"><span class="c006">-conds &lt;file&gt;</span></dt><dd class="dd-description"> Change the final condition of tests.
This is by far the most useful of these options:
in combination with option <span class="c004">-show prop</span> it permits a fine grain
selection of execution pictures.
</dd></dl>
<h3 class="subsection" id="herd:configfile">15.3&#XA0;&#XA0;Configuration files</h3>
<p>
The syntax of configuration files is minimal:
lines &#X201C;<span class="c010">key arg</span>&#X201D; are interpreted
as setting the value of parameter&#XA0;<span class="c010">key</span> to <span class="c010">arg</span>.
Each parameter has a corresponding option,
usually <span class="c004">-</span><span class="c010">key</span>, except for the single letter
option <span class="c004">-v</span> whose parameter is <span class="c004">verbose</span>.</p><p>As command line option are processed left-to-right,
settings from a configuration file (option <span class="c004">-conf</span>)
can be overridden by a later command line option.
Configuration files will be used mostly for controling pictures.
Some configuration files are
are present in the distribution.
As an example, here is the configuration file <a href="apoil.cfg"><span class="c004">apoil.cfg</span></a>,
which can be used to display images in <span class="c004">free</span> mode.
</p><pre class="verbatim">#Main graph mode
graph free
#Show memory events only
showevents memory
#Minimal information in nodes
squished true
#Do not show a legend at all
showlegend false

</pre><p>
The configuration above is commented with line comments that starts
with &#X201C;<code>#</code>&#X201D;.
The above configuration file comes handy to eye-proof model output,
even for relatively complex tests, such as <a href="IRIW+lwsyncs.litmus"><span class="c008">IRIW+lwsyncs</span></a>
and <a href="IRIW+syncs.litmus"><span class="c008">IRIW+syncs</span></a>:
</p><pre class="verbatim">% herd7 -conf apoil.cfg -show prop -gv IRIW+lwsyncs.litmus
% herd7 -through invalid -conf apoil.cfg -show prop -gv IRIW+syncs.litmus
</pre><p>We run the two tests on top of the default model that computes,
amongst others, a <span class="c004">prop</span> relation. The model rejects executions
with a cyclic <span class="c007">prop</span>.
One can then see that the relation <span class="c007">prop</span> is acyclic
for <span class="c008">IRIW+lwsyncs</span> and cyclic for <span class="c008">IRIW+syncs</span>:
</p><div class="center"><img src="IRIW+lwsyncs+APOIL.png">&#XA0;&#XA0;&#XA0;&#XA0;<img src="IRIW+syncs+APOIL.png"></div><p>
Notice that we used the option&#XA0;<span class="c004">-through invalid</span> in the case
of <span class="c008">IRIW+syncs</span> as we would otherwise have no image.</p>
<h3 class="subsection" id="herd:searchpath">15.4&#XA0;&#XA0;File searching</h3>
<p>
Configuration and model files are searched first in the current directory;
then in any directory specified
by setting the shell environment variable <span class="c004">HERDDIR</span>;
and then in herd installation directory, which is defined
while compiling&#XA0;<span class="c007">herd7</span>.</p>
<hr class="ffootnoterule"><dl class="thefootnotes"><dt class="dt-thefootnotes">
<a id="note4" href="#text4">4</a></dt><dd class="dd-thefootnotes"><div class="footnotetext">Alternatively,
we may adopt the simpler view that
a candidate execution includes a choice of all communication relations.</div></dd><dt class="dt-thefootnotes"><a id="note5" href="#text5">5</a></dt><dd class="dd-thefootnotes"><div class="footnotetext">Doing
so permits pruning executions that are irrelevant to the test final condition,
see <span class="c007">herd7</span> option <a href="#speedcheck%3Aopt"><span class="c004">-speedcheck</span></a></div></dd><dt class="dt-thefootnotes"><a id="note6" href="#text6">6</a></dt><dd class="dd-thefootnotes"><div class="footnotetext">This option requires
the Postscript visualiser <a href="http://www.gnu.org/software/gv/"><span class="c007">gv</span></a>.</div></dd><dt class="dt-thefootnotes"><a id="note7" href="#text7">7</a></dt><dd class="dd-thefootnotes"><div class="footnotetext">The setting of <span class="c004">showthread</span> is also changed, by the omitted <span class="c004">-showthread true</span> command line option</div></dd></dl>
<hr>
<a href="gen.html"><img src="previous_motif.gif" alt="Previous"></a>
<a href="index.html"><img src="contents_motif.gif" alt="Up"></a>
<a href="examples.html"><img src="next_motif.gif" alt="Next"></a>
</body>
</html>
